# åŠ è½½ Brotli æ¨¡å—
load_module /usr/lib/nginx/modules/ngx_http_brotli_filter_module.so;
load_module /usr/lib/nginx/modules/ngx_http_brotli_static_module.so;

worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 8192;        # ğŸš€ å¤§å¹…æå‡è¿æ¥æ•° (1024 -> 8192)
    use epoll;                      # Linuxé«˜æ•ˆäº‹ä»¶æ¨¡å‹
    multi_accept on;                # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥
    accept_mutex off;               # ğŸš€ å…³é—­æ¥å—é”ï¼Œæé«˜å¹¶å‘
}

http {
    # åŸºç¡€é…ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # ğŸš€ é«˜æ€§èƒ½ç½‘ç»œä¼ è¾“ä¼˜åŒ– - è·‘æ»¡å®½å¸¦æ ¸å¿ƒé…ç½®
    sendfile on;
    tcp_nopush on;                  # æ•°æ®åŒ…ä¼˜åŒ–
    tcp_nodelay on;                 # å‡å°‘å»¶è¿Ÿ
    keepalive_timeout 75s;          # ğŸš€ ä¿æŒè¿æ¥æ—¶é—´ (65s -> 75s)
    keepalive_requests 1000;        # ğŸš€ æ¯ä¸ªè¿æ¥çš„è¯·æ±‚æ•° (é»˜è®¤100 -> 1000)
    types_hash_max_size 4096;       # ğŸš€ å“ˆå¸Œè¡¨å¤§å° (2048 -> 4096)
    server_tokens off;

    # ğŸš€ å…³é”®ï¼šæ–‡ä»¶ä¼ è¾“ç¼“å†²åŒºä¼˜åŒ–
    output_buffers 8 32k;           # è¾“å‡ºç¼“å†²åŒº
    postpone_output 1460;           # å»¶è¿Ÿè¾“å‡ºé˜ˆå€¼ (MTUä¼˜åŒ–)

    # ğŸš€ å…³é”®ï¼šæ‰“å¼€æ–‡ä»¶ç¼“å­˜ä¼˜åŒ–
    open_file_cache max=10000 inactive=60s;
    open_file_cache_valid 120s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # ğŸš€ å®¢æˆ·ç«¯ç¼“å†²åŒºå¤§å¹…ä¼˜åŒ– - è·‘æ»¡å®½å¸¦å…³é”®
    client_max_body_size 64m;
    client_body_buffer_size 1m;     # ğŸš€ å¤§å¹…æå‡ (128k -> 1m)
    client_header_buffer_size 4k;   # è¯·æ±‚å¤´ç¼“å†²åŒº
    large_client_header_buffers 8 8k; # ğŸš€ å¤§è¯·æ±‚å¤´ç¼“å†²åŒº (4 256k -> 8 8k)

    # ğŸš€ å…³é”®ï¼šä»£ç†ç¼“å†²åŒºä¼˜åŒ–
    proxy_buffering on;
    proxy_buffer_size 16k;          # ğŸš€ ä»£ç†ç¼“å†²åŒºå¤§å° (é»˜è®¤4k -> 16k)
    proxy_buffers 32 16k;           # ğŸš€ ä»£ç†ç¼“å†²åŒºæ•°é‡ (é»˜è®¤8 4k -> 32 16k)
    proxy_busy_buffers_size 64k;    # ğŸš€ ç¹å¿™ç¼“å†²åŒºå¤§å° (é»˜è®¤8k -> 64k)

    # ğŸš€ è¿æ¥å¤ç”¨ä¼˜åŒ– - upstream keepaliveéœ€è¦åœ¨å…·ä½“çš„upstreamå—ä¸­é…ç½®
    # ç¤ºä¾‹: upstream backend { server 127.0.0.1:8080; keepalive 64; }

    # ========================================================================
    # CDN ä»£ç†ç¼“å­˜é…ç½®
    # ========================================================================

    # ä»£ç†ç¼“å­˜è·¯å¾„é…ç½®
    proxy_cache_path /var/cache/nginx/voidix
        levels=1:2
        keys_zone=voidix_cache:10m
        inactive=60m
        max_size=1g;

    proxy_temp_path /var/cache/nginx/voidix_temp;

    # ========================================================================
    # ğŸš€ æ€§èƒ½ç›‘æ§æ—¥å¿—æ ¼å¼ - ä¾¿äºæ€§èƒ½åˆ†æ
    # ========================================================================

    log_format main_perf '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for" '
                         'rt=$request_time uct="$upstream_connect_time" '
                         'uht="$upstream_header_time" urt="$upstream_response_time"';

    # ========================================================================
    # é€Ÿç‡é™åˆ¶é…ç½®
    # ========================================================================

    # CDN API è¯·æ±‚é™åˆ¶
    limit_req_zone $binary_remote_addr zone=cdn_api:10m rate=30r/m;

    # CDN èµ„æºè¯·æ±‚é™åˆ¶
    limit_req_zone $binary_remote_addr zone=cdn_assets:10m rate=60r/m;

    # ========================================================================
    # å¼•å…¥ç«™ç‚¹é…ç½®
    # ========================================================================
    include /etc/nginx/sites-enabled/*;
}
