# åŠ è½½ Brotli æ¨¡å—
load_module /usr/lib/nginx/modules/ngx_http_brotli_filter_module.so;
load_module /usr/lib/nginx/modules/ngx_http_brotli_static_module.so;

worker_processes auto;
error_log /var/log/nginx/error.log warn;

# ğŸ”¥ TTFBæ ¸å¿ƒä¼˜åŒ– - Workerè¿›ç¨‹ä¼˜åŒ–
worker_priority -10;                # ğŸ”¥ æé«˜workerè¿›ç¨‹ä¼˜å…ˆçº§
worker_rlimit_nofile 65535;         # ğŸ”¥ å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
worker_cpu_affinity auto;           # ğŸ”¥ è‡ªåŠ¨CPUäº²å’Œæ€§ç»‘å®š
worker_shutdown_timeout 30s;        # ğŸ”¥ ä¼˜é›…å…³é—­è¶…æ—¶

events {
    worker_connections 16384;       # ğŸš€ è¿›ä¸€æ­¥æå‡è¿æ¥æ•° (8192 -> 16384)
    use epoll;                      # Linuxé«˜æ•ˆäº‹ä»¶æ¨¡å‹
    multi_accept on;                # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥
    accept_mutex off;               # ğŸš€ å…³é—­æ¥å—é”ï¼Œæé«˜å¹¶å‘
    worker_aio_requests 512;        # ğŸš€ å¼‚æ­¥IOè¯·æ±‚æ•°é‡

    # ğŸ”¥ TTFBå…³é”®ä¼˜åŒ–
    epoll_events 1024;              # ğŸ”¥ å¢åŠ epolläº‹ä»¶æ•°é‡
}

http {
    # åŸºç¡€é…ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # ğŸš€ æè‡´é«˜æ€§èƒ½ç½‘ç»œä¼ è¾“ä¼˜åŒ– - è·‘æ»¡å®½å¸¦æ ¸å¿ƒé…ç½®
    sendfile on;
    sendfile_max_chunk 2m;          # ğŸš€ å•æ¬¡sendfileæœ€å¤§å—å¤§å°
    tcp_nopush on;                  # ğŸ”¥ æ‰¹é‡å‘é€ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
    tcp_nodelay on;                 # ğŸ”¥ å°æ•°æ®åŒ…ç«‹å³å‘é€
    keepalive_timeout 120s;         # ğŸš€ ä¿æŒé•¿è¿æ¥ (75s -> 120s)
    keepalive_requests 10000;       # ğŸš€ æè‡´è¿æ¥å¤ç”¨ (1000 -> 10000)
    keepalive_disable none;         # ğŸ”¥ ä¸ç¦ç”¨ä»»ä½•keep-alive
    types_hash_max_size 8192;       # ğŸš€ å“ˆå¸Œè¡¨å¤§å° (4096 -> 8192)
    server_tokens off;

    # ğŸš€ å…³é”®ï¼šæ–‡ä»¶ä¼ è¾“ç¼“å†²åŒºå¤§å¹…ä¼˜åŒ–
    output_buffers 2 512k;          # ğŸ”¥ è¾“å‡ºç¼“å†²åŒºä¼˜åŒ–
    postpone_output 0;              # ğŸ”¥ ä¸å»¶è¿Ÿè¾“å‡ºï¼Œç«‹å³å“åº”

    # ğŸš€ å…³é”®ï¼šæ‰“å¼€æ–‡ä»¶ç¼“å­˜å¤§å¹…ä¼˜åŒ–
    open_file_cache max=50000 inactive=300s;  # ğŸš€ æ›´å¤§ç¼“å­˜ (20000 -> 50000)
    open_file_cache_valid 300s;         # ğŸš€ å»¶é•¿æœ‰æ•ˆæœŸ (60s -> 300s)
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # ğŸš€ å®¢æˆ·ç«¯ç¼“å†²åŒºè¶…çº§ä¼˜åŒ– - è·‘æ»¡å®½å¸¦å…³é”®
    client_max_body_size 128m;      # ğŸš€ æå‡ä¸Šä¼ é™åˆ¶ (64m -> 128m)
    client_body_buffer_size 2m;     # ğŸš€ æå‡å®¢æˆ·ç«¯ç¼“å†²åŒº (1m -> 2m)
    client_header_buffer_size 32k;  # ğŸ”¥ å¢åŠ å¤´éƒ¨ç¼“å†²åŒº (1k -> 32k)
    large_client_header_buffers 8 128k; # ğŸ”¥ å¤§å¤´éƒ¨ç¼“å†²åŒºä¼˜åŒ–

    # ğŸš€ æ–°å¢ï¼šå®¢æˆ·ç«¯è¶…æ—¶ä¼˜åŒ–
    client_body_timeout 15s;        # ğŸ”¥ å‡å°‘ä¸»ä½“è¶…æ—¶ (60s -> 15s)
    client_header_timeout 15s;      # ğŸ”¥ å‡å°‘å¤´éƒ¨è¶…æ—¶ (60s -> 15s)
    send_timeout 10s;               # ğŸ”¥ å‡å°‘å‘é€è¶…æ—¶ (60s -> 10s)

    # ğŸš€ å…³é”®ï¼šä»£ç†ç¼“å†²åŒºæè‡´ä¼˜åŒ–
    proxy_buffering on;
    proxy_buffer_size 32k;          # ğŸš€ ä»£ç†ç¼“å†²åŒºå¤§å° (16k -> 32k)
    proxy_buffers 64 32k;           # ğŸš€ ä»£ç†ç¼“å†²åŒºæ•°é‡ (32 16k -> 64 32k)
    proxy_busy_buffers_size 128k;   # ğŸš€ ç¹å¿™ç¼“å†²åŒºå¤§å° (64k -> 128k)
    proxy_temp_file_write_size 128k; # ğŸš€ ä¸´æ—¶æ–‡ä»¶å†™å…¥å¤§å°

    # ğŸš€ æ–°å¢ï¼šä»£ç†è¿æ¥ä¼˜åŒ–
    proxy_connect_timeout 10s;      # ğŸš€ ä»£ç†è¿æ¥è¶…æ—¶
    proxy_send_timeout 30s;         # ğŸš€ ä»£ç†å‘é€è¶…æ—¶
    proxy_read_timeout 60s;         # ğŸš€ ä»£ç†è¯»å–è¶…æ—¶

    # ğŸš€ æ–°å¢ï¼šè¿æ¥å¤ç”¨å’ŒTCPä¼˜åŒ–
    reset_timedout_connection on;   # ğŸš€ é‡ç½®è¶…æ—¶è¿æ¥

    # ğŸ”¥ æ–°å¢ï¼šè¯·æ±‚ä½“å¤„ç†ä¼˜åŒ–
    client_body_temp_path /var/cache/nginx/client_temp;

    # ğŸš€ æ–°å¢ï¼šå†…å­˜æ˜ å°„ä¼˜åŒ–
    directio 16m;                   # ğŸš€ å¤§æ–‡ä»¶ç›´æ¥IOé˜ˆå€¼
    directio_alignment 4k;          # ğŸš€ ç›´æ¥IOå¯¹é½

    # ğŸ”¥ æ–°å¢ï¼šé”™è¯¯å¤„ç†ä¼˜åŒ–
    lingering_close on;             # ğŸ”¥ ä¼˜é›…å…³é—­è¿æ¥
    lingering_time 5s;              # ğŸ”¥ ç­‰å¾…å®¢æˆ·ç«¯å…³é—­æ—¶é—´
    lingering_timeout 2s;           # ğŸ”¥ ç­‰å¾…è¶…æ—¶æ—¶é—´

    # ========================================================================
    # CDN ä»£ç†ç¼“å­˜é…ç½®
    # ========================================================================

    # ä»£ç†ç¼“å­˜è·¯å¾„é…ç½®
    proxy_cache_path /var/cache/nginx/voidix
        levels=1:2
        keys_zone=voidix_cache:50m    # ğŸš€ å¢å¤§ç¼“å­˜åŒºåŸŸ (10m -> 50m)
        inactive=180m                 # ğŸš€ å»¶é•¿éæ´»è·ƒæ—¶é—´ (60m -> 180m)
        max_size=5g                   # ğŸš€ å¢å¤§æœ€å¤§ç¼“å­˜ (1g -> 5g)
        use_temp_path=off;            # ğŸš€ ç¦ç”¨ä¸´æ—¶è·¯å¾„æå‡æ€§èƒ½

    proxy_temp_path /var/cache/nginx/voidix_temp;

    # ğŸš€ æ–°å¢ï¼šé¢å¤–ç¼“å­˜åŒºåŸŸé…ç½®
    proxy_cache_path /var/cache/nginx/static
        levels=1:2
        keys_zone=static_cache:100m
        inactive=1440m
        max_size=10g
        use_temp_path=off;

    # ========================================================================
    # ğŸš€ æ€§èƒ½ç›‘æ§æ—¥å¿—æ ¼å¼ - ä¾¿äºæ€§èƒ½åˆ†æ
    # ========================================================================

    log_format main_perf '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for" '
                         'rt=$request_time uct="$upstream_connect_time" '
                         'uht="$upstream_header_time" urt="$upstream_response_time" '
                         'cs=$upstream_cache_status';  # ğŸš€ æ·»åŠ ç¼“å­˜çŠ¶æ€

    # ========================================================================
    # é€Ÿç‡é™åˆ¶é…ç½®ä¼˜åŒ–
    # ========================================================================

    # CDN API è¯·æ±‚é™åˆ¶ - æ›´å®½æ¾
    limit_req_zone $binary_remote_addr zone=cdn_api:20m rate=60r/m;  # ğŸš€ æå‡é™åˆ¶ (10m 30r/m -> 20m 60r/m)

    # CDN èµ„æºè¯·æ±‚é™åˆ¶ - æ›´å®½æ¾
    limit_req_zone $binary_remote_addr zone=cdn_assets:30m rate=120r/m; # ğŸš€ æå‡é™åˆ¶ (10m 60r/m -> 30m 120r/m)

    # ğŸš€ æ–°å¢ï¼šé™æ€èµ„æºä¸“ç”¨é™åˆ¶
    limit_req_zone $binary_remote_addr zone=static_files:20m rate=200r/m;

    # ========================================================================
    # å¼•å…¥ç«™ç‚¹é…ç½®
    # ========================================================================
    include /etc/nginx/sites-enabled/*;
}
