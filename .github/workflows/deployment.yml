name: ğŸš€ Production Deployment

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DEPLOY_PATH: '/var/www/voidix.net'

jobs:
  # ç›´æ¥éƒ¨ç½² - ä»£ç å·²é€šè¿‡PRæ£€æŸ¥
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    outputs:
      deployed: ${{ steps.changes.outputs.deploy_needed }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: ğŸ“ Restore Deployment Record
        uses: actions/cache/restore@v3
        id: cache-restore
        with:
          path: .deployment_record
          key: voidix-deployment-${{ github.sha }}
          restore-keys: |
            voidix-deployment-

      - name: ğŸ” Check for Code Changes
        id: changes
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç å˜æ›´..."

          # è·å–ä¸Šä¸€æ¬¡æˆåŠŸéƒ¨ç½²çš„æäº¤å“ˆå¸Œ
          LAST_DEPLOY_SHA=""

          # æ–¹æ³•1: ä»cacheæ¢å¤çš„éƒ¨ç½²è®°å½•è¯»å–
          if [[ -f ".deployment_record" ]]; then
            LAST_DEPLOY_SHA=$(cat ".deployment_record" 2>/dev/null | head -1 || echo "")
            if [[ -n "$LAST_DEPLOY_SHA" ]]; then
              echo "ğŸ“ ä»ç¼“å­˜è®°å½•è·å–åˆ°ä¸Šæ¬¡éƒ¨ç½²: $LAST_DEPLOY_SHA"
            fi
          else
            echo "ğŸ“ éƒ¨ç½²è®°å½•æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ–¹æ³•2: é€šè¿‡GitHub APIè·å–ä¸Šä¸€æ¬¡æˆåŠŸçš„éƒ¨ç½²å·¥ä½œæµï¼ˆå¤‡ç”¨ï¼‰
          if [[ -z "$LAST_DEPLOY_SHA" ]]; then
            echo "ğŸ“¡ æŸ¥è¯¢GitHub Actionså†å²ä½œä¸ºå¤‡ç”¨..."
            WORKFLOW_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deployment.yml/runs?status=completed&conclusion=success&per_page=5")

            # è§£ææœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„éƒ¨ç½²ï¼ˆæ’é™¤å½“å‰è¿è¡Œï¼‰
            LAST_DEPLOY_SHA=$(echo "$WORKFLOW_RUNS" | jq -r '.workflow_runs[] | select(.head_sha != "'${{ github.sha }}'") | .head_sha' | head -1)

            if [[ -n "$LAST_DEPLOY_SHA" && "$LAST_DEPLOY_SHA" != "null" ]]; then
              echo "âœ… ä»GitHub APIè·å–åˆ°ä¸Šæ¬¡éƒ¨ç½²: $LAST_DEPLOY_SHA"
            fi
          fi

          # æ–¹æ³•3: æ—¶é—´ç­–ç•¥ï¼ˆæœ€ç»ˆå¤‡ç”¨ï¼‰
          if [[ -z "$LAST_DEPLOY_SHA" || "$LAST_DEPLOY_SHA" == "null" ]]; then
            echo "â° ä½¿ç”¨æ—¶é—´ç­–ç•¥ï¼šæ£€æŸ¥æœ€è¿‘24å°æ—¶çš„å˜æ›´"
            SINCE_TIME=$(date -d '24 hours ago' --iso-8601 2>/dev/null || date -v-24H +%Y-%m-%dT%H:%M:%S 2>/dev/null || echo "")
            if [[ -n "$SINCE_TIME" ]]; then
              LAST_DEPLOY_SHA=$(git log --since="$SINCE_TIME" --format="%H" | tail -1)
              if [[ -n "$LAST_DEPLOY_SHA" ]]; then
                echo "âœ… ä»æ—¶é—´ç­–ç•¥è·å–åˆ°åŸºå‡†: $LAST_DEPLOY_SHA"
              fi
            fi
          fi

          # æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
          if [[ -z "$LAST_DEPLOY_SHA" || "$LAST_DEPLOY_SHA" == "null" ]]; then
            echo "ğŸ”™ ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥æœ€è¿‘5æ¬¡æäº¤"
            LAST_DEPLOY_SHA="HEAD~5"
          fi

          # ğŸ›¡ï¸ ç»Ÿä¸€çš„amendè¾¹ç¼˜æƒ…å†µæ£€æµ‹ï¼ˆå¯¹æ‰€æœ‰è·å–åˆ°çš„SHAè¿›è¡ŒéªŒè¯ï¼‰
          if [[ -n "$LAST_DEPLOY_SHA" && "$LAST_DEPLOY_SHA" != "HEAD~5" ]]; then
            echo "ğŸ” éªŒè¯åŸºå‡†commitæ˜¯å¦å­˜åœ¨..."
            if ! git cat-file -e "$LAST_DEPLOY_SHA" 2>/dev/null; then
              echo "âš ï¸ åŸºå‡†commitä¸å­˜åœ¨ï¼Œå¯èƒ½è¢«amend/rebase/force-pushäº†"
              echo "ğŸ”„ fallbackåˆ°æ—¶é—´ç­–ç•¥"

              # fallbackåˆ°æ—¶é—´ç­–ç•¥
              SINCE_TIME=$(date -d '24 hours ago' --iso-8601 2>/dev/null || date -v-24H +%Y-%m-%dT%H:%M:%S 2>/dev/null || echo "")
              if [[ -n "$SINCE_TIME" ]]; then
                LAST_DEPLOY_SHA=$(git log --since="$SINCE_TIME" --format="%H" | tail -1)
                if [[ -n "$LAST_DEPLOY_SHA" ]]; then
                  echo "âœ… fallbackæˆåŠŸï¼Œæ–°åŸºå‡†: $LAST_DEPLOY_SHA"
                else
                  echo "ğŸ”™ æ—¶é—´ç­–ç•¥ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ"
                  LAST_DEPLOY_SHA="HEAD~5"
                fi
              else
                echo "ğŸ”™ æ—¶é—´ç­–ç•¥å¤±è´¥ï¼Œä½¿ç”¨æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ"
                LAST_DEPLOY_SHA="HEAD~5"
              fi

              # æ¸…é™¤å¯èƒ½å·²æŸåçš„cacheè®°å½•
              if [[ -f ".deployment_record" ]]; then
                echo "ğŸ—‘ï¸ æ¸…é™¤æŸåçš„éƒ¨ç½²è®°å½•"
                rm -f ".deployment_record"
              fi
            else
              echo "âœ… åŸºå‡†commitéªŒè¯é€šè¿‡"
            fi
          fi

          echo "ğŸ“ ä¸Šæ¬¡éƒ¨ç½²åŸºå‡†ç‚¹: $LAST_DEPLOY_SHA"
          echo "ğŸ“ å½“å‰HEAD: ${{ github.sha }}"

          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          if [[ "$LAST_DEPLOY_SHA" == "${{ github.sha }}" ]]; then
            echo "ğŸ”„ å½“å‰æäº¤ä¸ä¸Šæ¬¡éƒ¨ç½²ç›¸åŒï¼Œè·³è¿‡éƒ¨ç½²"
            echo "deploy_needed=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ğŸ” æ¯”è¾ƒä¸Šæ¬¡éƒ¨ç½²åˆ°å½“å‰çš„å˜æ›´"
            CHANGED_FILES=$(git diff --name-only "$LAST_DEPLOY_SHA"..${{ github.sha }} 2>/dev/null || echo "")
          fi

          echo "å˜æ›´çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"

          # å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•å˜æ›´æ–‡ä»¶ï¼Œæ ¹æ®æƒ…å†µå†³å®š
          if [[ -z "$CHANGED_FILES" ]]; then
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "âš ï¸ æ‰‹åŠ¨è§¦å‘ä¸”æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ‰§è¡Œéƒ¨ç½²"
              echo "deploy_needed=true" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ è‡ªåŠ¨è§¦å‘ä¸”æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
              echo "deploy_needed=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # æ’é™¤ä¸éœ€è¦é‡æ–°éƒ¨ç½²çš„æ–‡ä»¶ç±»å‹
          EXCLUDED_PATTERNS="
          \.md$
          ^docs/
          ^\.github/workflows/
          ^\.github/ISSUE_TEMPLATE/
          ^\.github/pull_request_template\.md$
          ^\.gitignore$
          ^LICENSE
          ^codecov\.yml$
          \.test\.(ts|tsx|js|jsx)$
          \.spec\.(ts|tsx|js|jsx)$
          ^src/test/
          \.eslintrc
          \.prettierrc
          ^README\.
          ^CHANGELOG\.
          ^CONTRIBUTING\.
          "

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦éƒ¨ç½²çš„å®è´¨æ€§å˜æ›´
          DEPLOYMENT_REQUIRED=false

          while IFS= read -r file; do
            if [[ -n "$file" ]]; then
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ¹é…æ’é™¤æ¨¡å¼
              SHOULD_EXCLUDE=false
              while IFS= read -r pattern; do
                if [[ -n "$pattern" && "$file" =~ $pattern ]]; then
                  SHOULD_EXCLUDE=true
                  break
                fi
              done <<< "$EXCLUDED_PATTERNS"

              if [[ "$SHOULD_EXCLUDE" == false ]]; then
                echo "âœ… å‘ç°éœ€è¦éƒ¨ç½²çš„å˜æ›´: $file"
                DEPLOYMENT_REQUIRED=true
                break
              else
                echo "â­ï¸ è·³è¿‡ééƒ¨ç½²ç›¸å…³æ–‡ä»¶: $file"
              fi
            fi
          done <<< "$CHANGED_FILES"

          if [[ "$DEPLOYMENT_REQUIRED" == true ]]; then
            echo "ğŸš€ æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œç»§ç»­éƒ¨ç½²"
            echo "deploy_needed=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ æœªæ£€æµ‹åˆ°éœ€è¦éƒ¨ç½²çš„ä»£ç å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
            echo "deploy_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Setup SSH Key
        if: steps.changes.outputs.deploy_needed == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸŒ Add Server to Known Hosts
        if: steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "ğŸ”‘ Adding server to known hosts..."
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to Production Server
        if: steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨..."

          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
            # è®¾ç½®é”™è¯¯æ—¶ç«‹å³é€€å‡º
            set -e

            # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
            echo "ğŸ† Production Deployment Started"
            echo "ğŸ“… Time: $(date)"
            echo "ğŸ–¥ï¸  Server: $(hostname)"
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸ“ Target: ${{ env.DEPLOY_PATH }}"
            echo ""

            # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
            cd ${{ env.DEPLOY_PATH }}

            # éªŒè¯è¿™æ˜¯ä¸€ä¸ªgitä»“åº“
            if [[ ! -d ".git" ]]; then
              echo "âŒ é”™è¯¯ï¼š${{ env.DEPLOY_PATH }} ä¸æ˜¯ä¸€ä¸ªgitä»“åº“"
              exit 1
            fi

            # ç¡®ä¿åœ¨æ­£ç¡®çš„å·¥ä½œç›®å½•
            CURRENT_DIR=$(pwd)
            if [[ "$CURRENT_DIR" != "${{ env.DEPLOY_PATH }}" ]]; then
              echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½• $CURRENT_DIR ä¸æ˜¯é¢„æœŸçš„ ${{ env.DEPLOY_PATH }}"
              exit 1
            fi

            echo "âœ… ç›®å½•éªŒè¯é€šè¿‡ï¼š$CURRENT_DIR"

            # æ˜¾ç¤ºå½“å‰åˆ†æ”¯ä¿¡æ¯
            echo "ğŸ“Š Current Status:"
            echo "ğŸŒ¿ Current branch: $(git branch --show-current)"
            echo "ğŸ“ Latest commit: $(git log -1 --oneline)"
            echo ""

            # æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ˜¯å¦å­˜åœ¨
            DEPLOY_SCRIPT_PATH="./scripts/CICD/deploy.sh"
            if [[ ! -f "$DEPLOY_SCRIPT_PATH" ]]; then
              echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOY_SCRIPT_PATH"
              echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              echo "ğŸ“ scriptsç›®å½•å†…å®¹:"
              ls -la scripts/ 2>/dev/null || echo "scriptsç›®å½•ä¸å­˜åœ¨"
              echo "ğŸ“ scripts/CICDç›®å½•å†…å®¹:"
              ls -la scripts/CICD/ 2>/dev/null || echo "scripts/CICDç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

            # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
            echo "ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
            chmod +x "$DEPLOY_SCRIPT_PATH"

            # è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆç¡®ä¿åœ¨æ­£ç¡®ç›®å½•ä¸‹æ‰§è¡Œï¼‰
            echo "ğŸ”¥ Running deployment script from $(pwd)..."
            sudo "$DEPLOY_SCRIPT_PATH"

            echo ""
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Website: https://www.voidix.net"
            echo "â° Completed at: $(date)"
            echo "ğŸ“ Deployment commit: ${{ github.sha }}"
          DEPLOY_SCRIPT

      - name: ğŸ“ Record Deployment Commit
        if: success() && steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "ğŸ“ è®°å½•æœ¬æ¬¡éƒ¨ç½²commit..."
          echo "${{ github.sha }}" > .deployment_record
          echo "ğŸ“… $(date --iso-8601=seconds)" >> .deployment_record
          echo "ğŸ·ï¸  ${{ github.ref_name }}" >> .deployment_record
          echo "âœ… éƒ¨ç½²è®°å½•å·²ä¿å­˜"

      - name: ğŸ’¾ Save Deployment Record
        if: success() && steps.changes.outputs.deploy_needed == 'true'
        uses: actions/cache/save@v3
        with:
          path: .deployment_record
          key: voidix-deployment-${{ github.sha }}

      - name: â­ï¸ Deployment Skipped Notification
        if: steps.changes.outputs.deploy_needed == 'false'
        run: |
          echo "â­ï¸ éƒ¨ç½²å·²è·³è¿‡"
          echo "ğŸ“‹ åŸå› : æœªæ£€æµ‹åˆ°éœ€è¦é‡æ–°éƒ¨ç½²çš„ä»£ç å˜æ›´"
          echo "ğŸ’¡ åªæœ‰æ–‡æ¡£ã€æµ‹è¯•æ–‡ä»¶æˆ–é…ç½®æ–‡ä»¶å‘ç”Ÿäº†å˜æ›´"

      - name: âœ… Deployment Success Notification
        if: success() && steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://www.voidix.net"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"

      - name: âŒ Deployment Failure Notification
        if: failure() && steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          echo "ğŸ“‹ è¯·æŸ¥çœ‹ä¸Šè¿°é”™è¯¯ä¿¡æ¯è¿›è¡Œæ’æŸ¥ã€‚"
          exit 1

  # éƒ¨ç½²åéªŒè¯
  post-deployment-verification:
    name: ğŸ” Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success() && needs.deploy.outputs.deployed == 'true'

    steps:
      - name: ğŸŒ Website Accessibility Check
        run: |
          echo "ğŸŒ æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."

          # åŸºç¡€HTTPæ£€æŸ¥
          if curl -f -s --max-time 30 "https://www.voidix.net" > /dev/null; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âš ï¸ ç½‘ç«™è®¿é—®æ£€æŸ¥å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
          fi

          # SSLè¯ä¹¦æ£€æŸ¥
          if curl -f -s --max-time 10 "https://www.voidix.net" | head -1 > /dev/null; then
            echo "âœ… HTTPSæ­£å¸¸å·¥ä½œ"
          else
            echo "âš ï¸ HTTPSæ£€æŸ¥å¼‚å¸¸"
          fi

      - name: ğŸ“Š Deployment Summary
        run: |
          echo ""
          echo "==============================================="
          echo "ğŸ† éƒ¨ç½²å®Œæˆæ€»ç»“"
          echo "==============================================="
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ ç½‘ç«™åœ°å€: https://www.voidix.net"
          echo "ğŸ”„ éƒ¨ç½²æ–¹å¼: è‡ªåŠ¨åŒ–CICD"
          echo "âœ… çŠ¶æ€: æˆåŠŸå®Œæˆ"
          echo "==============================================="
