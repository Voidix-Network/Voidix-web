name: ğŸ” Code Check

on:
  pull_request:
    branches: [master]
  merge_group:
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  CACHE_KEY_PREFIX: 'voidix-web'

jobs:
  # å¿«é€Ÿæ£€æŸ¥ - ä»£ç é£æ ¼å’Œç±»å‹æ£€æŸ¥
  quick-checks:
    name: âš¡ Quick Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ¨ Style Check
        run: |
          echo "ğŸ¨ Running Prettier style check..."
          npm run style:check
          echo "âœ… Style check passed"

      - name: ğŸ“‹ Type Check
        run: |
          echo "ğŸ“‹ Running TypeScript type check..."
          npm run type-check
          echo "âœ… Type check passed"

  # è´¨é‡æ£€æµ‹
  quality-analysis:
    name: ğŸ“Š Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Code Quality Check
        run: |
          echo "ğŸ” Running comprehensive TypeScript compilation check..."
          npx tsc --noEmit --pretty
          echo "âœ… Code quality check passed"

      - name: ğŸ“ Build Verification
        run: |
          echo "ğŸ“ Verifying build process..."
          npm run build:basic
          echo "ğŸ“Š Analyzing build output..."
          ls -la dist/
          du -sh dist/
          echo "âœ… Build verification completed"

  # æµ‹è¯•å¥—ä»¶
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª Run Tests with Coverage
        run: |
          echo "ğŸ§ª Running test suite with coverage..."
          npm run test:coverage
          echo "âœ… Tests completed"

      - name: ğŸ“Š Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ğŸ“ˆ Coverage Summary
        if: always()
        run: |
          echo "ğŸ“ˆ Test Coverage Summary:"
          if [ -f coverage/lcov.info ]; then
            echo "âœ… Coverage report generated successfully"
            grep -o 'Lines.*[0-9]*\.[0-9]*%' coverage/lcov-report/index.html || echo "Coverage details available in artifacts"
          else
            echo "âš ï¸ Coverage report not found"
          fi

  # å®‰å…¨æ£€æµ‹
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ›¡ï¸ Dependency Security Audit
        run: |
          echo "ğŸ›¡ï¸ Running dependency security scan..."

          echo "ğŸ“¦ Checking for outdated dependencies..."
          npm outdated || echo "â„¹ï¸ Some dependencies may be outdated (non-blocking)"

          echo "ğŸ” Running security audit (ignoring low severity per GitHub recommendation)..."
          npm audit --audit-level=moderate || echo "â„¹ï¸ Low severity vulnerabilities found but ignored (GitHub recommendation for production apps)"

          echo "ğŸ“œ Checking license compatibility (will fail on incompatible licenses)..."
          npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Python-2.0;BlueOak-1.0.0;MIT-0;CC-BY-4.0" --excludePrivatePackages
          echo "âœ… Security scan passed"

  # æœ€ç»ˆæŠ¥å‘Š
  final-report:
    name: ğŸ“‹ Final Report
    runs-on: ubuntu-latest
    needs: [quick-checks, quality-analysis, test-suite, security-scan]
    if: always()

    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "ğŸ¯ Code Quality Pipeline Results"
          echo "================================"
          echo "âš¡ Quick Checks: ${{ needs.quick-checks.result }}"
          echo "ğŸ“Š Quality Analysis: ${{ needs.quality-analysis.result }}"
          echo "ğŸ§ª Test Suite: ${{ needs.test-suite.result }}"
          echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo ""

          if [[ "${{ needs.quick-checks.result }}" == "success" && "${{ needs.quality-analysis.result }}" == "success" && "${{ needs.test-suite.result }}" == "success" && "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "ğŸ† Overall Status: âœ… PASSED"
            echo "âœ¨ Code is ready for deployment"
          else
            echo "ğŸ† Overall Status: âŒ FAILED"
            echo "âš ï¸ Some checks require attention"

            # æ˜¾ç¤ºè¯¦ç»†çš„å¤±è´¥ä¿¡æ¯
            if [[ "${{ needs.quick-checks.result }}" != "success" ]]; then
              echo "   âŒ Quick Checks failed"
            fi
            if [[ "${{ needs.quality-analysis.result }}" != "success" ]]; then
              echo "   âŒ Quality Analysis failed"
            fi
            if [[ "${{ needs.test-suite.result }}" != "success" ]]; then
              echo "   âŒ Test Suite failed"
            fi
            if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
              echo "   âŒ Security Scan failed - SECURITY ISSUES DETECTED"
            fi

            exit 1
          fi

          echo ""
          echo "ğŸ“… Pipeline completed at: $(date)"
          echo "ğŸ”— Commit: ${GITHUB_SHA:0:8}"
          echo "ğŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
