# CodeQL å®‰å…¨åˆ†æå·¥ä½œæµ
# ç”¨äºè‡ªåŠ¨æ£€æµ‹ä»£ç ä¸­çš„å®‰å…¨æ¼æ´å’Œè´¨é‡é—®é¢˜
# ä¸¥æ ¼ç¨‹åº¦ï¼šMedium åŠä»¥ä¸Šä¸¥é‡æ€§ï¼ŒWarning åŠä»¥ä¸Šçº§åˆ«ï¼ˆå¹³è¡¡å®‰å…¨æ€§å’Œå¼€å‘æ•ˆç‡ï¼‰

name: ğŸ”’ CodeQL Analysis

on:
  # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  push:
    branches: [master]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'package*.json'
      - '.github/workflows/CodeQL.yml'

  # Pull Request æ—¶è§¦å‘
  pull_request:
    branches: [master]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'package*.json'
      - '.github/workflows/CodeQL.yml'

  # æ¯å‘¨å®šæœŸæ‰«æï¼ˆå‘¨ä¸€ UTC 2:00ï¼‰
  schedule:
    - cron: '0 2 * * 1'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: read # è¯»å–ä»“åº“å†…å®¹
  security-events: write # å†™å…¥å®‰å…¨äº‹ä»¶åˆ° Security æ ‡ç­¾é¡µ
  actions: read # è¯»å– Actions æƒé™

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  LANGUAGE: 'typescript' # CodeQL åˆ†æè¯­è¨€

jobs:
  # CodeQL å®‰å…¨åˆ†æä¸»ä»»åŠ¡
  codeql-analysis:
    name: ğŸ” CodeQL Analysis
    runs-on: ubuntu-latest

    # å®‰å…¨ç­–ç•¥ï¼šä»…åœ¨å…¬å¼€ä»“åº“æˆ–æœ‰æƒé™æ—¶è¿è¡Œ
    if: github.repository == 'Voidix-Network/voidix-web' || github.event_name != 'schedule'

    strategy:
      fail-fast: false
      matrix:
        # æ”¯æŒå¤šè¯­è¨€åˆ†æï¼ˆå½“å‰èšç„¦JavaScript/TypeScriptï¼‰
        language: ['typescript']

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # æ·±åº¦å…‹éš†ä»¥è·å–å®Œæ•´å†å²ï¼Œæå‡åˆ†æè´¨é‡
          fetch-depth: 2

      # æ­¥éª¤2: è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      # æ­¥éª¤3: å®‰è£…é¡¹ç›®ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies for CodeQL analysis..."
          npm ci --prefer-offline --no-audit --silent
          echo "âœ… Dependencies installed successfully"

      # æ­¥éª¤4: åˆå§‹åŒ– CodeQL
      - name: ğŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # ä½¿ç”¨æ ‡å‡†å®‰å…¨æŸ¥è¯¢å¥—ä»¶ (Medium+ ä¸¥é‡æ€§)
          queries: security-and-quality
          # è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰
          config: |
            name: "Voidix Web CodeQL Config - Medium+ Strictness"
            queries:
              - uses: security-and-quality
            paths-ignore:
              - 'dist'
              - 'coverage'
              - 'node_modules'
              - '**/*.test.ts'
              - '**/*.test.tsx'
              - '**/*.spec.ts'
              - '**/*.spec.tsx'
            paths:
              - 'src'
              - 'scripts'

      # æ­¥éª¤5: æ„å»ºé¡¹ç›®ï¼ˆä¸º CodeQL æä¾›ç¼–è¯‘ä¿¡æ¯ï¼‰
      - name: ğŸ—ï¸ Build Project for Analysis
        run: |
          echo "ğŸ—ï¸ Building project for CodeQL analysis..."
          echo "ğŸ“‹ Running TypeScript compilation check..."
          npm run type-check
          echo "ğŸ“¦ Creating production build..."
          npm run build:basic
          echo "âœ… Build completed successfully"

        # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿç»§ç»­ CodeQL åˆ†æ
        continue-on-error: true

      # æ­¥éª¤6: æ‰§è¡Œ CodeQL åˆ†æ
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        id: codeql-analyze
        with:
          category: '/language:${{ matrix.language }}'
          # ä¸Šä¼ ç»“æœåˆ° GitHub Security æ ‡ç­¾é¡µ
          upload: true
          # ç­‰å¾…åˆ†æå®Œæˆçš„è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
          wait-for-processing: true
          # è¾“å‡ºSARIFç»“æœæ–‡ä»¶è·¯å¾„ä»¥ä¾›åç»­æ£€æŸ¥
          output: './codeql-results.sarif'

        # åˆ†æå¤±è´¥æ—¶çš„å¤„ç†
        continue-on-error: false

      # æ­¥éª¤6.5: æ£€æŸ¥CodeQLç»“æœä¸¥é‡æ€§
      - name: ğŸš¨ Check CodeQL Results Severity
        if: always() && steps.codeql-analyze.conclusion == 'success'
        run: |
          echo "ğŸ” Checking CodeQL analysis results for Medium+ severity issues..."

          # æ£€æŸ¥æ˜¯å¦æœ‰SARIFç»“æœæ–‡ä»¶
          if [ -f "./codeql-results.sarif" ]; then
            echo "ğŸ“„ SARIF results file found, analyzing..."

            # ä½¿ç”¨jqè§£æSARIFæ–‡ä»¶æ£€æŸ¥ä¸¥é‡æ€§çº§åˆ«
            # æ£€æŸ¥æ˜¯å¦æœ‰errorã€warningçº§åˆ«çš„é—®é¢˜ï¼Œä»¥åŠmedium+ä¸¥é‡æ€§é—®é¢˜
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error" or (.properties.severity // "low") | test("critical|high|medium"; "i"))] | length' ./codeql-results.sarif 2>/dev/null || echo "0")
            WARNING_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' ./codeql-results.sarif 2>/dev/null || echo "0")
            TOTAL_ISSUES=$(jq '[.runs[].results[]] | length' ./codeql-results.sarif 2>/dev/null || echo "0")

            echo "ğŸ“Š CodeQL Results Summary:"
            echo "â€¢ Total Issues: $TOTAL_ISSUES"
            echo "â€¢ Critical/High/Medium: $CRITICAL_COUNT"
            echo "â€¢ Warnings: $WARNING_COUNT"
            echo ""

            # å¦‚æœæœ‰Critical/High/Mediumçº§åˆ«é—®é¢˜ï¼Œè®©å·¥ä½œæµå¤±è´¥
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "âŒ SECURITY ALERT: Found $CRITICAL_COUNT Critical/High/Medium severity issues!"
              echo "ğŸš« Blocking deployment due to security concerns"
              echo ""
              echo "ğŸ“‹ Required Actions:"
              echo "â€¢ Review issues in Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
              echo "â€¢ Fix Critical/High/Medium severity vulnerabilities"
              echo "â€¢ Re-run CodeQL analysis after fixes"
              echo ""
              echo "ğŸ”— Security Dashboard: https://github.com/${{ github.repository }}/security"
              exit 1
            fi

            # å¦‚æœæœ‰Warningçº§åˆ«é—®é¢˜ï¼Œç»™å‡ºè­¦å‘Šä½†ä¸å¤±è´¥ï¼ˆæ ¹æ®éœ€è¦å¯è°ƒæ•´ï¼‰
            if [ "$WARNING_COUNT" -gt 0 ]; then
              echo "âš ï¸ Found $WARNING_COUNT Warning level issues"
              echo "ğŸ’¡ Review these issues in Security tab for code quality improvements"
              echo "âœ… Proceeding with deployment (Warning level issues don't block)"
            fi

            if [ "$TOTAL_ISSUES" -eq 0 ]; then
              echo "ğŸ‰ No security issues detected - CodeQL analysis passed!"
            fi

          else
            echo "âš ï¸ No SARIF results file found, using alternative check..."

            # æ£€æŸ¥GitHub APIè·å–æœ€æ–°çš„ä»£ç æ‰«æè­¦æŠ¥
            echo "ğŸ” Checking for recent code scanning alerts via API..."

            # å¦‚æœæ²¡æœ‰SARIFæ–‡ä»¶ï¼Œæˆ‘ä»¬å‡è®¾åˆ†ææˆåŠŸæ„å‘³ç€æ²¡æœ‰é˜»å¡é—®é¢˜
            echo "âœ… CodeQL analysis completed successfully"
          fi

      # æ­¥éª¤7: åˆ†æç»“æœå¤„ç†
      - name: ğŸ“Š Process Analysis Results
        if: always()
        run: |
          echo "ğŸ“Š CodeQL Analysis Summary"
          echo "=========================="
          echo "ğŸ”¤ Language: ${{ matrix.language }}"
          echo "ğŸ“… Scan Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
          echo "ğŸ”— Commit: ${GITHUB_SHA:0:8}"
          echo ""
          echo "ğŸ“‹ Analysis Details:"
          echo "â€¢ Scope: TypeScript/JavaScript security analysis"
          echo "â€¢ Queries: Security + Quality ruleset"
          echo "â€¢ Strictness: Medium+ severity, Warning+ level"
          echo "â€¢ Target: React + TypeScript + Vite application"
          echo ""
          echo "ğŸ¯ Severity Handling (Medium+ æ¨¡å¼):"
          echo "â€¢ Critical/High/Medium: Will block deployment"
          echo "â€¢ Low/Info: Reported for review only"
          echo "â€¢ Warning+: All reported and tracked"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… CodeQL analysis completed successfully"
            echo "ğŸ” Results uploaded to GitHub Security tab"
            echo "ğŸ’¡ Check the Security tab for detailed findings"
          else
            echo "âš ï¸ CodeQL analysis encountered issues"
            echo "ğŸ”§ Please review the workflow logs for details"
          fi

          echo ""
          echo "ğŸ”— View results: https://github.com/${{ github.repository }}/security/code-scanning"

  # å®‰å…¨æ‰«ææ€»ç»“ä»»åŠ¡
  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: codeql-analysis
    if: always()

    steps:
      - name: ğŸ›¡ï¸ Security Analysis Summary
        run: |
          echo "ğŸ›¡ï¸ Voidix Web - Security Analysis Summary"
          echo "========================================"
          echo ""
          echo "ğŸ” CodeQL Analysis: ${{ needs.codeql-analysis.result }}"
          echo "ğŸ“… Scan Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸ¯ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
          echo "ğŸ”— Commit: ${GITHUB_SHA:0:8}"
          echo ""
          echo "âš™ï¸ Configuration:"
          echo "â€¢ Severity: Medium+ (Critical, High, Medium block deployment)"
          echo "â€¢ Reporting: Warning+ level issues tracked"
          echo "â€¢ Queries: Security + Quality"
          echo "â€¢ Dependencies: Medium+ vulnerabilities block PR"
          echo ""

          # æ ¹æ® CodeQL åˆ†æç»“æœæä¾›å»ºè®®
          if [[ "${{ needs.codeql-analysis.result }}" == "success" ]]; then
            echo "âœ… Security Analysis Status: PASSED"
            echo ""
            echo "ğŸ‰ No high-severity security issues detected"
            echo "ğŸ” Detailed results available in Security tab"
            echo "ğŸ“Š Continue monitoring for security best practices"
            echo ""
            echo "ğŸ“‹ Next Steps:"
            echo "â€¢ Review any medium/low severity findings"
            echo "â€¢ Keep dependencies updated"
            echo "â€¢ Follow secure coding practices"
          elif [[ "${{ needs.codeql-analysis.result }}" == "failure" ]]; then
            echo "âŒ Security Analysis Status: FAILED"
            echo ""
            echo "ğŸš¨ Critical security issues detected!"
            echo "ğŸš« Deployment blocked due to security concerns"
            echo ""
            echo "ğŸ“‹ Required Actions:"
            echo "â€¢ Check Security tab for detailed findings"
            echo "â€¢ Fix Critical/High/Medium severity vulnerabilities"
            echo "â€¢ Verify build and dependency configurations"
            echo "â€¢ Re-run analysis after fixes"
            echo ""
            echo "âš ï¸ This workflow will continue to fail until security issues are resolved"
            exit 1
          else
            echo "âš ï¸ Security Analysis Status: ATTENTION REQUIRED"
            echo ""
            echo "ğŸ”§ CodeQL analysis needs attention"
            echo "ğŸ” Please review workflow logs and findings"
            echo ""
            echo "ğŸ“‹ Recommended Actions:"
            echo "â€¢ Check Security tab for detailed findings"
            echo "â€¢ Review and fix identified security issues"
            echo "â€¢ Verify build and dependency configurations"
            echo "â€¢ Re-run analysis after fixes"
          fi

          echo ""
          echo "ğŸ”— Security Dashboard: https://github.com/${{ github.repository }}/security"
          echo "ğŸ“– Learn more: https://docs.github.com/en/code-security/code-scanning"

        # ç¡®ä¿æ€»ç»“å§‹ç»ˆè¿è¡Œ
        if: always()

  dependency-review:
    name: ğŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # å¤±è´¥é˜ˆå€¼ï¼šMedium åŠä»¥ä¸Šä¸¥é‡æ€§æ¼æ´æ—¶å¤±è´¥ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
          fail-on-severity: medium
          # å…è®¸çš„è®¸å¯è¯ç±»å‹ï¼ˆåŒ…æ‹¬æ‰€æœ‰é¡¹ç›®ä½¿ç”¨çš„å¼€æºè®¸å¯è¯ï¼‰
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, Python-2.0, BlueOak-1.0.0, MIT-0, CC-BY-4.0
          # æ‹’ç»çš„è®¸å¯è¯ç±»å‹
          deny-licenses: GPL-2.0, GPL-3.0

        # ç§»é™¤continue-on-errorï¼Œè®©Medium+é—®é¢˜é˜»æ­¢åˆå¹¶
        # continue-on-error: true  # å·²ç§»é™¤ï¼Œç¡®ä¿Medium+é—®é¢˜ä¼šè®©å·¥ä½œæµå¤±è´¥
