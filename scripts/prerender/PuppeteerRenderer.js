import { minify } from 'html-minifier-terser';
import puppeteer from 'puppeteer';
import { createLogger } from '../utils/logger.js';

const logger = createLogger('PuppeteerRenderer');

/**
 * Puppeteeræ¸²æŸ“å™¨
 * è´Ÿè´£ä½¿ç”¨Puppeteerè¿›è¡Œé¡µé¢é¢„æ¸²æŸ“
 */
export class PuppeteerRenderer {
  constructor(config) {
    this.config = config;
    this.browser = null;

    // ğŸ”¥ HTMLç»ˆæå‹ç¼©é…ç½® - æé™ä¼˜åŒ–
    this.minifyOptions = {
      // === åŸºç¡€å‹ç¼© ===
      collapseWhitespace: true,        // âœ… å‹ç¼©ç©ºç™½ç¬¦
      removeComments: true,            // âœ… ç§»é™¤æ³¨é‡Š
      removeRedundantAttributes: true, // âœ… ç§»é™¤å†—ä½™å±æ€§
      removeScriptTypeAttributes: true,// âœ… ç§»é™¤script type
      removeStyleLinkTypeAttributes: true, // âœ… ç§»é™¤style/link type
      useShortDoctype: true,           // âœ… ä½¿ç”¨çŸ­DOCTYPE
      removeEmptyAttributes: true,     // âœ… ç§»é™¤ç©ºå±æ€§
      html5: true,                     // âœ… HTML5æ¨¡å¼
      caseSensitive: false,            // âœ… å¤§å°å†™ä¸æ•æ„Ÿ

      // === ğŸ”¥ æé™å‹ç¼©é€‰é¡¹ ===
      removeOptionalTags: true,        // ğŸ”¥ ç§»é™¤å¯é€‰æ ‡ç­¾ï¼ˆå¦‚</li>, </p>ï¼‰
      removeAttributeQuotes: true,     // ğŸ”¥ ç§»é™¤å±æ€§å¼•å·ï¼ˆid=testè€Œéid="test"ï¼‰
      removeEmptyElements: true,       // ğŸ”¥ ç§»é™¤ç©ºå…ƒç´ 
      collapseBooleanAttributes: true, // ğŸ”¥ å‹ç¼©å¸ƒå°”å±æ€§ï¼ˆcheckedè€Œéchecked="checked"ï¼‰
      collapseInlineTagWhitespace: true, // ğŸ”¥ å‹ç¼©å†…è”æ ‡ç­¾ç©ºç™½
      conservativeCollapse: false,     // ğŸ”¥ æ¿€è¿›ç©ºç™½å‹ç¼©
      decodeEntities: true,            // ğŸ”¥ è§£ç HTMLå®ä½“
      includeAutoGeneratedTags: false, // ğŸ”¥ ä¸åŒ…å«è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾
      keepClosingSlash: false,         // ğŸ”¥ ç§»é™¤è‡ªé—­åˆæ ‡ç­¾çš„æ–œæ 
      processConditionalComments: true, // ğŸ”¥ å¤„ç†æ¡ä»¶æ³¨é‡Š
      processScripts: ['text/html'],   // ğŸ”¥ å¤„ç†è„šæœ¬å†…å®¹
      removeTagWhitespace: true,       // ğŸ”¥ ç§»é™¤æ ‡ç­¾é—´ç©ºç™½
      sortAttributes: true,            // ğŸ”¥ æ’åºå±æ€§ï¼ˆå‡å°‘gzipé‡å¤ï¼‰
      sortClassName: true,             // ğŸ”¥ æ’åºclassåï¼ˆå‡å°‘gzipé‡å¤ï¼‰
      trimCustomFragments: true,       // ğŸ”¥ ä¿®å‰ªè‡ªå®šä¹‰ç‰‡æ®µ

      // === CSS/JS å†…è”å‹ç¼© ===
      minifyCSS: {
        level: 2,                      // ğŸ”¥ CSSæœ€é«˜çº§åˆ«å‹ç¼©
        compatibility: '*',            // ğŸ”¥ å¿½ç•¥å…¼å®¹æ€§è­¦å‘Š
      },
      minifyJS: {
        compress: {
          drop_console: true,          // ğŸ”¥ ç§»é™¤console
          drop_debugger: true,         // ğŸ”¥ ç§»é™¤debugger
          pure_funcs: ['console.log'], // ğŸ”¥ çº¯å‡½æ•°ä¼˜åŒ–
        },
        mangle: true,                  // ğŸ”¥ æ··æ·†å˜é‡å
        format: {
          comments: false,             // ğŸ”¥ ç§»é™¤æ‰€æœ‰æ³¨é‡Š
        },
      },

      // === é«˜çº§é€‰é¡¹ ===
      ignoreCustomComments: [/^!/],   // ä¿ç•™é‡è¦æ³¨é‡Šï¼ˆå¦‚è®¸å¯è¯ï¼‰
      maxLineLength: 0,                // ğŸ”¥ æ— è¡Œé•¿åº¦é™åˆ¶ï¼ˆå•è¡Œè¾“å‡ºï¼‰
      preserveLineBreaks: false,       // ğŸ”¥ ä¸ä¿ç•™æ¢è¡Œç¬¦
      preventAttributesEscaping: false, // ğŸ”¥ å…è®¸å±æ€§è½¬ä¹‰ä¼˜åŒ–
      quoteCharacter: '"',             // ç»Ÿä¸€å¼•å·é£æ ¼

      ...config.htmlMinify || {}
    };
  }

  /**
   * åˆå§‹åŒ–æµè§ˆå™¨
   */
  async initBrowser() {
    try {
      logger.start('å¯åŠ¨Puppeteeræµè§ˆå™¨');
      this.browser = await puppeteer.launch(this.config.puppeteer);
      logger.success('Puppeteeræµè§ˆå™¨å¯åŠ¨æˆåŠŸ');
      return true;
    } catch (error) {
      logger.error('Puppeteeræµè§ˆå™¨å¯åŠ¨å¤±è´¥', error);
      return false;
    }
  }

  /**
   * é¢„æ¸²æŸ“å•ä¸ªè·¯ç”±
   */
  async renderRoute(route, serverPort) {
    const { path: routePath, outputDir } = route;
    const url = `http://localhost:${serverPort}${routePath}`;

    logger.step(`é¢„æ¸²æŸ“è·¯ç”±: ${routePath}`);

    try {
      const page = await this.browser.newPage();

      // ğŸš€ ä¼˜åŒ–ï¼šç¦ç”¨å¯èƒ½é€ æˆé˜»å¡çš„åŠŸèƒ½
      await page.setRequestInterception(true);
      page.on('request', (request) => {
        const resourceType = request.resourceType();
        // é˜»æ­¢å¯èƒ½é€ æˆTBTçš„èµ„æº
        if (['websocket', 'eventsource', 'font', 'media', 'image'].includes(resourceType)) {
          request.abort();
        } else {
          request.continue();
        }
      });

      // ğŸš€ ä¼˜åŒ–ï¼šæ³¨å…¥ç¯å¢ƒå˜é‡ï¼Œç¦ç”¨WebSocketç­‰
      await page.evaluateOnNewDocument(() => {
        // ç¦ç”¨WebSocketè¿æ¥
        window.PRERENDER_MODE = true;
        window.DISABLE_WEBSOCKET = true;

        // æ¨¡æ‹ŸWebSocketä»¥é˜²æ­¢é”™è¯¯
        window.WebSocket = class MockWebSocket {
          constructor() {
            this.readyState = 3; // CLOSED
          }
          send() {}
          close() {}
          addEventListener() {}
          removeEventListener() {}
        };

        // ç¦ç”¨ä¸€äº›å¯èƒ½é˜»å¡çš„API
        window.fetch = () => Promise.resolve(new Response('{}'));

        // åŠ é€Ÿå®šæ—¶å™¨
        const originalSetTimeout = window.setTimeout;
        window.setTimeout = (fn, delay) => originalSetTimeout(fn, Math.min(delay, 100));
      });

      // è®¾ç½®è§†å£
      await page.setViewport({
        width: this.config.render.viewportWidth,
        height: this.config.render.viewportHeight,
      });

      // ğŸš€ ä¼˜åŒ–ï¼šæ›´å¿«çš„é¡µé¢åŠ è½½ç­–ç•¥
      await page.goto(url, {
        waitUntil: 'domcontentloaded', // ä¸ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½
        timeout: this.config.render.timeout,
      });

      // ğŸš€ ä¼˜åŒ–ï¼šç­‰å¾…Reactæ¸²æŸ“å®Œæˆä½†é™åˆ¶ç­‰å¾…æ—¶é—´
      try {
        await page.waitForFunction(
          () => {
            // æ£€æŸ¥Reactæ˜¯å¦æ¸²æŸ“å®Œæˆï¼Œç‰¹åˆ«æ£€æŸ¥ä¸»è¦å†…å®¹æ˜¯å¦å­˜åœ¨
            const root = document.querySelector('#root');
            if (!root || root.children.length === 0) return false;

            // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingElement = document.querySelector('.loading-fade-in');
            if (loadingElement) return false;

            // æ£€æŸ¥ä¸»è¦å†…å®¹æ˜¯å¦å·²æ¸²æŸ“
            const mainContent = document.querySelector('main');
            if (!mainContent) return false;

            // æ£€æŸ¥h1æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼ˆä¸ºäº†SEOï¼‰
            const h1Element = document.querySelector('h1');
            if (!h1Element) return false;

            return true;
          },
          { timeout: 8000 } // å¢åŠ åˆ°8ç§’ç­‰å¾…æ—¶é—´
        );

        // é¢å¤–ç­‰å¾…ä¸€äº›åŠ¨ç”»å®Œæˆ
        await page.waitForTimeout(1000);

      } catch (timeoutError) {
        logger.warn(`ç­‰å¾…æ¸²æŸ“å®Œæˆè¶…æ—¶: ${routePath}, ç»§ç»­ä½¿ç”¨å½“å‰çŠ¶æ€`);

        // è¶…æ—¶åæ£€æŸ¥å½“å‰çŠ¶æ€
        const hasH1 = await page.$('h1');
        if (!hasH1) {
          logger.error(`âš ï¸ æœªæ£€æµ‹åˆ°h1æ ‡ç­¾: ${routePath}`);
        }
      }

      // è·å–åˆå§‹çš„ã€åŒ…å«éª¨æ¶å±çš„HTML
      let html = await page.content();

      // å‹ç¼©HTML
      try {
        const minifiedHtml = await minify(html, this.minifyOptions);
        const originalSize = html.length;
        const minifiedSize = minifiedHtml.length;
        const compression = ((originalSize - minifiedSize) / originalSize * 100).toFixed(1);

        logger.info(`  HTMLå‹ç¼©: ${originalSize} â†’ ${minifiedSize} å­—ç¬¦ (å‡å°‘ ${compression}%)`);
        html = minifiedHtml;
      } catch (minifyError) {
        logger.warn(`HTMLå‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹HTML: ${minifyError.message}`);
      }

      // å…³é—­é¡µé¢
      await page.close();

      logger.success(`é¢„æ¸²æŸ“å®Œæˆ: ${routePath}`);

      return {
        route: routePath,
        outputDir,
        html,
        size: html.length,
      };
    } catch (error) {
      logger.error(`é¢„æ¸²æŸ“å¤±è´¥: ${routePath}`, error);
      return null;
    }
  }

  /**
   * æ‰¹é‡é¢„æ¸²æŸ“è·¯ç”±
   */
  async renderRoutes(routes, serverPort) {
    const results = [];

    for (const route of routes) {
      const result = await this.renderRoute(route, serverPort);
      if (result) {
        results.push(result);
      }
    }

    return results;
  }

  /**
   * å…³é—­æµè§ˆå™¨
   */
  async closeBrowser() {
    try {
      if (this.browser) {
        await this.browser.close();
        logger.success('Puppeteeræµè§ˆå™¨å·²å…³é—­');
      }
    } catch (error) {
      logger.error('å…³é—­Puppeteeræµè§ˆå™¨å¤±è´¥', error);
    }
  }
}
