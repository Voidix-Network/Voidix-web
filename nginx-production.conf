# Voidixç½‘ç«™ç”Ÿäº§ç¯å¢ƒNginxé…ç½®
# åŸºäºç°ä»£React+TypeScript+Viteæ¶æ„ä¼˜åŒ–

# ============================================================================
# CDNä»£ç†é…ç½®è¯´æ˜
# ============================================================================
# æœ¬é…ç½®åŒ…å«CDNä»£ç†åŠŸèƒ½ï¼Œéœ€è¦åœ¨ä¸»nginx.confçš„httpå—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
# proxy_cache_path /var/cache/nginx/voidix levels=1:2 keys_zone=voidix_cache:10m inactive=60m;
# proxy_temp_path /var/cache/nginx/voidix_temp;
#
# ä»¥åŠRate Limitingé…ç½®ï¼š
# limit_req_zone $binary_remote_addr zone=cdn_api:10m rate=30r/m;
# limit_req_zone $binary_remote_addr zone=cdn_assets:10m rate=60r/m;
#
# ä»£ç†åŠŸèƒ½åŒ…æ‹¬ï¼š
# - Minecraftå¤´åƒAPIä»£ç†å’Œç¼“å­˜
# - UptimeRobotç›‘æ§APIä»£ç†å’Œç¼“å­˜
# - Google Fontsä»£ç†å’Œç¼“å­˜
# - è‡ªåŠ¨æ’é™¤åˆ†æJSè„šæœ¬ï¼ˆGAã€å­—èŠ‚è·³åŠ¨ç­‰ï¼‰
# - SEOå‹å¥½çš„CDNé˜²ç›—é“¾ä¿æŠ¤æœºåˆ¶ï¼ˆå…è®¸æœç´¢å¼•æ“çˆ¬è™«ï¼‰
# ============================================================================

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name voidix.net;

    # å¼ºåˆ¶HTTPSé‡å®šå‘åˆ°www.voidix.net
    return 301 https://www.voidix.net$request_uri;
}

server {
    listen 80;
    listen [::]:80;
    server_name www.voidix.net cdn.voidix.net;

    # å¼ºåˆ¶HTTPSé‡å®šå‘
    return 301 https://$server_name$request_uri;
}

# HTTPSéwwwåŸŸåé‡å®šå‘åˆ°www
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name voidix.net;

    # SSLåŒè¯ä¹¦é…ç½® - ECCä¼˜å…ˆï¼ŒRSAå…¼å®¹
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # å¼ºåˆ¶é‡å®šå‘åˆ°www.voidix.net
    return 301 https://www.voidix.net$request_uri;
}

# HTTPSä¸»é…ç½®
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.voidix.net;

    # ğŸš€ HTTP/2 é«˜æ€§èƒ½ä¼˜åŒ– - è·‘æ»¡å®½å¸¦å…³é”®
    large_client_header_buffers 8 64k;  # ğŸš€ æ›¿ä»£http2_max_field_sizeå’Œhttp2_max_header_size
    keepalive_requests 10000;           # ğŸš€ è¿æ¥å¤ç”¨ (æ›¿ä»£http2_max_requests)
    # http2_recv_buffer_sizeå·²ç§»é™¤ - åœ¨æ–°ç‰ˆæœ¬nginxä¸­å·²åºŸå¼ƒ

    # SSLåŒè¯ä¹¦é…ç½® - ECCä¼˜å…ˆï¼ŒRSAå…¼å®¹
    # ECCè¯ä¹¦ï¼ˆç°ä»£å®¢æˆ·ç«¯ï¼Œæ›´é«˜æ•ˆï¼‰
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;

    # RSAè¯ä¹¦ï¼ˆä¼ ç»Ÿå®¢æˆ·ç«¯å…¼å®¹ï¼‰
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off; # For TLSv1.3, preference is largely client-driven; 'off' is fine.
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off; # Enhances forward secrecy.

    # HSTSå®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # å®‰å…¨å¤´é…ç½®
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always; # For older browsers, modern ones rely more on CSP.
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # CSPå†…å®¹å®‰å…¨ç­–ç•¥ - ä¸ºReactåº”ç”¨å’Œæœç´¢å¼•æ“è„šæœ¬ä¼˜åŒ–
    # æ³¨æ„: 'unsafe-inline' for script-src may be required by some JS/React patterns but is less secure.
    # æ³¨æ„: 'unsafe-eval' for script-src is a security risk; ensure it's absolutely necessary.
    # æ³¨æ„: 'https:' in img-src is broad; specify domains if possible for tighter security.
    # æ³¨æ„: 'connect-src wss://$host;' assumes WebSocket connections (if any) are to the same host.
    #       If the /ws proxy is for dev HMR only, this might not be needed or could be more specific for prod.

    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://lf1-cdn-tos.bytegoofy.com https://b.clarity.ms https://k.clarity.ms https://*.clarity.ms; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.voidix.net; font-src 'self' https://fonts.gstatic.com https://cdn.voidix.net; img-src 'self' data: https: blob: https://cdn.voidix.net; connect-src 'self' https://www.google-analytics.com https://api.uptimerobot.com https://cdn.voidix.net wss://$host wss://server.voidix.top:10203 https://b.clarity.ms https://k.clarity.ms https://*.clarity.ms; object-src 'none'; base-uri 'self'; form-action 'self';" always;

    # ç½‘ç«™æ ¹ç›®å½• - æŒ‡å‘æ„å»ºæ–‡ä»¶ç›®å½•
    root /var/www/voidix.net/dist;
    index index.html;

    # ğŸ† é¢„å‹ç¼©æ–‡ä»¶ä¸“ç”¨é…ç½®ï¼ˆé›¶CPUæ¶ˆè€—ï¼‰
    # åªä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶ï¼Œç¦ç”¨å®æ—¶å‹ç¼©ç¡®ä¿æœ€å¿«å“åº”
    brotli off;                 # ç¦ç”¨å®æ—¶å‹ç¼©ï¼Œå¼ºåˆ¶ä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶
    brotli_static on;           # å¯ç”¨é™æ€é¢„å‹ç¼©æ–‡ä»¶æ”¯æŒï¼ˆæŸ¥æ‰¾.bræ–‡ä»¶ï¼‰
    brotli_min_length 512;      # é™ä½æœ€å°å‹ç¼©æ–‡ä»¶å¤§å°ï¼Œå°æ–‡ä»¶ä¹Ÿå‹ç¼©
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/javascript
        application/json
        application/xml
        application/xml+rss
        application/atom+xml
        application/rss+xml
        image/svg+xml
        font/woff
        font/woff2
        font/ttf
        font/eot
        font/otf;

    # ğŸ—œï¸ é¢„å‹ç¼©Gzipé…ç½®ï¼ˆé›¶CPUæ¶ˆè€—å›é€€ï¼‰
    gzip off;                   # ç¦ç”¨å®æ—¶å‹ç¼©ï¼Œå¼ºåˆ¶ä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶
    gzip_vary on;
    gzip_min_length 512;        # é™ä½æœ€å°å‹ç¼©å¤§å°
    gzip_static on;             # å¯ç”¨é™æ€é¢„å‹ç¼©æ–‡ä»¶æ”¯æŒï¼ˆæŸ¥æ‰¾.gzæ–‡ä»¶ï¼‰
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2;

    # SEOä¼˜åŒ–ï¼šHTMLæ‰©å±•åé‡å®šå‘é…ç½® - ä¼˜å…ˆå¤„ç†
    # å°† /x.html é‡å®šå‘åˆ° /xï¼ˆæ— æ‰©å±•åï¼‰
    # ä½¿ç”¨è´Ÿå‘å‰ç»æ–­è¨€æ’é™¤ index.html é¿å…é‡å®šå‘å¾ªç¯
    location ~ ^/(?!index)(.+)\.html$ {
        return 301 /$1;
    }

    # é™æ€èµ„æºæ–‡ä»¶å¤„ç† - ä¸å­˜åœ¨çš„æ–‡ä»¶é‡å®šå‘åˆ°React 404é¡µé¢
    # æ³¨æ„ï¼šä¸åŒ…å«htmlæ–‡ä»¶ï¼Œhtmlæ–‡ä»¶ç”±ä¸Šé¢çš„é‡å®šå‘è§„åˆ™å¤„ç†
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|map|txt|xml)$ {
        # ğŸ† é¢„å‹ç¼©æ–‡ä»¶ä¼˜å…ˆï¼Œå¿«é€Ÿå®æ—¶å›é€€
        brotli_static on;
        gzip_static on;

        # å°è¯•æä¾›é™æ€æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é‡å®šå‘åˆ° /not-found
        try_files $uri @static_not_found;

        # é™æ€æ–‡ä»¶ç¼“å­˜é…ç½®
        expires 1y;
        add_header Cache-Control "public, immutable";
        # X-Content-Type-Options "nosniff" is already set globally.

        # å­—ä½“æ–‡ä»¶CORSæ”¯æŒ
        location ~* \.(woff|woff2)$ {
            add_header Access-Control-Allow-Origin "*";
            # expires and Cache-Control are inherited from the parent location.
        }
    }

    # PWAå›¾æ ‡å’ŒLogoæ–‡ä»¶ä¸“ç”¨é…ç½® - é˜²æ­¢è¿‡åº¦è¯·æ±‚
    location ~* ^/(android-chrome-|apple-touch-icon|favicon\.|logo\.) {
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
        # Content-Type will be determined by Nginx based on mime.types for flexibility (e.g. favicon.ico, logo.svg)

        # æ·»åŠ ETagæ”¯æŒï¼Œå‡å°‘é‡å¤ä¼ è¾“
        etag on;

        # è®¿é—®æ—¥å¿—å•ç‹¬è®°å½•ï¼ˆå¯é€‰ï¼‰
        access_log /var/log/nginx/voidix_icons.log;
    }

    # é™æ€æ–‡ä»¶ä¸å­˜åœ¨æ—¶é‡å®šå‘åˆ°React 404é¡µé¢
    location @static_not_found {
        return 302 /not-found;
    }

    # ä¸»è·¯ç”±é…ç½® - SPAåº”ç”¨è·¯ç”±ï¼Œå¤„ç†å…¶ä»–æ‰€æœ‰è¯·æ±‚
    location / {
        # å°è¯•æä¾›æ–‡ä»¶æˆ–ç›®å½•ï¼Œä¸å­˜åœ¨åˆ™å›é€€åˆ°index.html
        try_files $uri $uri/ /index.html;
    }

    # é¢„æ¸²æŸ“é¡µé¢ç›´æ¥æœåŠ¡ï¼ˆSEOä¼˜åŒ–ï¼‰
    location /status {
        try_files /status/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location /faq {
        try_files /faq/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location /bug-report {
        try_files /bug-report/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location /privacy {
        try_files /privacy/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # APIä»£ç†é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocketæ”¯æŒï¼ˆé€šå¸¸ç”¨äºå¼€å‘ç¯å¢ƒçƒ­é‡è½½ e.g., Vite HMR)
    # Consider removing or securing this appropriately if not used/needed in production.
    location /ws {
        proxy_pass http://localhost:5173; # Typically Vite dev server
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header Origin ""; # May be needed for dev server origin check
    }

    # SEOä¼˜åŒ–æ–‡ä»¶
    location = /robots.txt {
        add_header Content-Type text/plain;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    location = /sitemap.xml {
        add_header Content-Type application/xml;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # éšè—æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to .md, .json (except if explicitly served by other rules like static assets if manifest.json is used), .lock, .log files
    # Be cautious with denying all .json if specific JSON files need to be served from non-asset paths.
    location ~ \.(md|json|lock|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # é”™è¯¯é¡µé¢é…ç½®
    # åªæœ‰æœåŠ¡å™¨é”™è¯¯æ‰é‡å®šå‘åˆ°index.htmlï¼Œ404äº¤ç»™ä¸Šé¢çš„é…ç½®å¤„ç†
    error_page 500 502 503 504 /index.html;

    # è®¿é—®æ—¥å¿—é…ç½®
    access_log /var/log/nginx/voidix_access.log;
    error_log /var/log/nginx/voidix_error.log;
}

# ============================================================================
# CDNå­åŸŸåé…ç½® - cdn.voidix.net ä¸“ç”¨ä»£ç†æœåŠ¡
# ============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name cdn.voidix.net;

    # ğŸš€ HTTP/2 CDNé«˜æ€§èƒ½ä¼˜åŒ–
    large_client_header_buffers 8 64k;  # ğŸš€ æ›¿ä»£http2å¤´éƒ¨ä¼˜åŒ–æŒ‡ä»¤
    keepalive_requests 10000;           # ğŸš€ è¿æ¥å¤ç”¨ä¼˜åŒ–
    # http2_recv_buffer_sizeå·²ç§»é™¤ - åœ¨æ–°ç‰ˆæœ¬nginxä¸­å·²åºŸå¼ƒ

    # SSLè¯ä¹¦é…ç½® - ä½¿ç”¨é€šé…ç¬¦è¯ä¹¦æˆ–å­åŸŸåè¯ä¹¦
    # This structure is correct for Nginx to offer both ECC and RSA certificates.
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # HSTSå®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CDNä¸“ç”¨å®‰å…¨å¤´
    add_header X-Frame-Options "DENY" always; # More restrictive for CDN assets
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # CDNæœåŠ¡æ ‡è¯†
    add_header X-CDN-Provider "Voidix-CDN" always;
    add_header X-Served-By "cdn.voidix.net" always;

    # ğŸ† CDNæè‡´Brotliå‹ç¼©é…ç½®ï¼ˆä½å¹¶å‘ä¸“ç”¨ï¼‰
    brotli on;
    brotli_comp_level 11;       # CDNæœ€é«˜å‹ç¼©çº§åˆ«ï¼ˆä½å¹¶å‘é«˜æ€§èƒ½ä¼˜åŒ–ï¼‰
    brotli_min_length 512;      # å°æ–‡ä»¶ä¹Ÿå‹ç¼©
    brotli_static on;           # CDNé¢„å‹ç¼©æ–‡ä»¶æ”¯æŒ
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/javascript
        application/json
        application/xml
        application/xml+rss
        application/atom+xml
        application/rss+xml
        image/svg+xml
        font/woff
        font/woff2
        font/ttf
        font/eot
        font/otf;

    # ğŸ—œï¸ CDNæè‡´Gzipå‹ç¼©é…ç½®ï¼ˆæœ€é«˜å…¼å®¹æ€§å›é€€ï¼‰
    gzip on;
    gzip_vary on;
    gzip_min_length 512;        # å°æ–‡ä»¶å‹ç¼©
    gzip_comp_level 9;          # æœ€é«˜å‹ç¼©çº§åˆ«
    gzip_static on;             # CDNé¢„å‹ç¼©æ–‡ä»¶æ”¯æŒ
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2;

    # ========================================================================
    # Google Fontsä»£ç†
    # ========================================================================

    location /fonts/css/ {
        limit_req zone=cdn_assets burst=10 nodelay;
        rewrite ^/fonts/css/(.*)$ /$1 break;

        proxy_pass https://fonts.googleapis.com;
        proxy_cache voidix_cache;
        proxy_cache_key "fonts_css:$request_uri";
        proxy_cache_valid 200 7d;
        proxy_cache_valid 404 1h;
        proxy_cache_valid any 1h;

        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=604800, immutable";
        add_header X-CDN-Cache "fonts-css" always;
        add_header Access-Control-Allow-Origin "*" always;

        proxy_set_header Host "fonts.googleapis.com";
        proxy_set_header User-Agent "VoidixCDN/1.0 (+https://cdn.voidix.net)";
        proxy_set_header Accept "text/css,*/*;q=0.1";

        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 10s;
        access_log /var/log/nginx/cdn_fonts_css.log;
    }

    location /fonts/files/ {
        limit_req zone=cdn_assets burst=10 nodelay;
        rewrite ^/fonts/files/(.*)$ /$1 break;

        proxy_pass https://fonts.gstatic.com;
        proxy_cache voidix_cache;
        proxy_cache_key "fonts_files:$request_uri";
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1d;
        proxy_cache_valid any 1h;

        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=2592000, immutable";
        add_header X-CDN-Cache "fonts-files" always;
        add_header Access-Control-Allow-Origin "*" always;

        proxy_set_header Host "fonts.gstatic.com";
        proxy_set_header User-Agent "VoidixCDN/1.0 (+https://cdn.voidix.net)";
        proxy_set_header Accept "font/woff2,font/woff,*/*;q=0.1";

        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 15s;
        access_log /var/log/nginx/cdn_fonts_files.log;
    }

    # ========================================================================
    # å®‰å…¨ç­–ç•¥ - ç¦æ­¢åˆ†æJSä»£ç†
    # ========================================================================
    location ~* /(googletagmanager|google-analytics|lf1-cdn-tos\.bytegoofy) {
        return 403 "åˆ†æè„šæœ¬ä¸å…è®¸é€šè¿‡CDNä»£ç†";
    }

    # ========================================================================
    # CDNçŠ¶æ€å’Œå¥åº·æ£€æŸ¥
    # ========================================================================
    location = /cdn-status {
        access_log off;
        return 200 '{"status":"healthy","service":"voidix-cdn","version":"1.0"}';
        add_header Content-Type "application/json";
        add_header X-CDN-Status "active";
    }

    # é»˜è®¤æ‹’ç»å…¶ä»–è¯·æ±‚
    location / {
        return 404 "CDNæœåŠ¡ï¼šè¯·æ±‚çš„èµ„æºä¸å­˜åœ¨";
    }

    # éšè—æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # è®¿é—®æ—¥å¿—é…ç½®
    access_log /var/log/nginx/cdn_access.log;
    error_log /var/log/nginx/cdn_error.log;
}
