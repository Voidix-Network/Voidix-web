# Voidixç½‘ç«™ç”Ÿäº§ç¯å¢ƒNginxé…ç½®
# åŸºäºç°ä»£React+TypeScript+Viteæ¶æ„ä¼˜åŒ–
#
# ğŸ”’ SSL/TLSåŒè¯ä¹¦é…ç½®è¯´æ˜ï¼š
# - ECCè¯ä¹¦ï¼šç°ä»£æµè§ˆå™¨ä¼˜å…ˆï¼Œæ€§èƒ½æœ€ä½³ï¼Œä½“ç§¯æœ€å°
# - RSAè¯ä¹¦ï¼šä¼ ç»Ÿæµè§ˆå™¨å…¼å®¹ï¼Œå‘åå…¼å®¹æ€§æœ€å¥½
#
# ğŸš€ å½“å‰ç®—æ³•ä¼˜å…ˆçº§ï¼šECC > RSA
# ğŸ”¥ A+è¯„çº§SSLé…ç½®ï¼šå‰å‘ä¿å¯†ä¼˜å…ˆã€TLS 1.3ã€HSTS 2å¹´æœŸé™

# ============================================================================
# ğŸ”’ HSTSå®‰å…¨æ”¯æŒ - HTTPå¼ºåˆ¶é‡å®šå‘åˆ°HTTPS
# ============================================================================

# ä¸»ç«™HTTPé‡å®šå‘
server {
    listen 80;
    listen [::]:80;
    server_name www.voidix.net voidix.net;

    # ğŸ”’ HSTSé¢„åŠ è½½ - å³ä½¿HTTPä¹Ÿè¿”å›HSTSå¤´ï¼ˆ2å¹´æœŸé™ï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ğŸš€ æ°¸ä¹…é‡å®šå‘åˆ°HTTPS - SEOå‹å¥½
    return 301 https://www.voidix.net$request_uri;
}

# CDN HTTPé‡å®šå‘
server {
    listen 80;
    listen [::]:80;
    server_name cdn.voidix.net;

    # ğŸ”’ HSTSé¢„åŠ è½½ï¼ˆCDN HTTPé‡å®šå‘ - 2å¹´æœŸé™ï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ğŸš€ CDNé‡å®šå‘åˆ°HTTPS
    return 301 https://cdn.voidix.net$request_uri;
}

# ğŸ”’ é€šé…ç¬¦å­åŸŸåHTTPSé‡å®šå‘æ”¯æŒ
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # ğŸ”’ HSTSé¢„åŠ è½½ï¼ˆé€šé…ç¬¦é‡å®šå‘ - 2å¹´æœŸé™ï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ğŸš€ æ‰€æœ‰å­åŸŸåé‡å®šå‘åˆ°ä¸»ç«™HTTPS
    return 301 https://www.voidix.net$request_uri;
}

# ============================================================================
# CDNä»£ç†é…ç½®è¯´æ˜
# ============================================================================
# æœ¬é…ç½®åŒ…å«CDNä»£ç†åŠŸèƒ½ï¼Œéœ€è¦åœ¨ä¸»nginx.confçš„httpå—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
# proxy_cache_path /var/cache/nginx/voidix levels=1:2 keys_zone=voidix_cache:50m inactive=180m max_size=5g;
# proxy_temp_path /var/cache/nginx/voidix_temp;
#
# ä»¥åŠRate Limitingé…ç½®ï¼š
# limit_req_zone $binary_remote_addr zone=cdn_api:20m rate=60r/m;
# limit_req_zone $binary_remote_addr zone=cdn_assets:30m rate=120r/m;
# limit_req_zone $binary_remote_addr zone=static_files:20m rate=200r/m;
#
# ä»£ç†åŠŸèƒ½åŒ…æ‹¬ï¼š
# - Minecraftå¤´åƒAPIä»£ç†å’Œç¼“å­˜
# - UptimeRobotç›‘æ§APIä»£ç†å’Œç¼“å­˜
# - Google Fontsä»£ç†å’Œç¼“å­˜
# - è‡ªåŠ¨æ’é™¤åˆ†æJSè„šæœ¬ï¼ˆGAã€å­—èŠ‚è·³åŠ¨ç­‰ï¼‰
# - SEOå‹å¥½çš„CDNé˜²ç›—é“¾ä¿æŠ¤æœºåˆ¶ï¼ˆå…è®¸æœç´¢å¼•æ“çˆ¬è™«ï¼‰
# ============================================================================

# ============================================================================
# ä¸»ç«™HTTPSé…ç½®
# ============================================================================
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;
    server_name www.voidix.net;

        # ğŸš€ HTTP/2 è¶…çº§é«˜æ€§èƒ½ä¼˜åŒ– - è·‘æ»¡å®½å¸¦å…³é”®
    large_client_header_buffers 16 128k; # ğŸš€ å¤§å¹…æå‡ (8 64k -> 16 128k)
    keepalive_requests 50000;           # ğŸš€ æè‡´è¿æ¥å¤ç”¨ (10000 -> 50000)

    # ğŸš€ æ–°å¢ï¼šHTTP/2 æ¨é€ä¼˜åŒ–é…ç½®
    http2_push_preload on;              # ğŸš€ å¯ç”¨é¢„åŠ è½½æ¨é€
    http2_max_concurrent_streams 256;   # ğŸš€ æœ€å¤§å¹¶å‘æµ

    # ğŸ”¥ æ–°å¢ï¼šTTFBæè‡´ä¼˜åŒ–
    postpone_output 0;                  # ğŸ”¥ ç«‹å³å‘é€å“åº”ï¼Œä¸ç­‰å¾…ç¼“å†²åŒºæ»¡
    tcp_nopush off;                     # ğŸ”¥ ç¦ç”¨tcp_nopushï¼Œå‡å°‘å»¶è¿Ÿ
    tcp_nodelay on;                     # ğŸ”¥ å¯ç”¨TCP_NODELAYï¼Œç«‹å³å‘é€å°æ•°æ®åŒ…

    # ğŸ”¥ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
    sendfile on;
    sendfile_max_chunk 512k;            # ğŸ”¥ å‡å°å—å¤§å°ï¼Œæé«˜å“åº”æ€§ (2m -> 512k)

    # ğŸ”¥ å¼€å¯å¼‚æ­¥IOï¼ˆéœ€è¦ç³»ç»Ÿæ”¯æŒï¼‰
    aio threads;                        # ğŸ”¥ å¼‚æ­¥æ–‡ä»¶IO
    directio 4m;                        # ğŸ”¥ å¤§æ–‡ä»¶ç›´æ¥IOé˜ˆå€¼ (16m -> 4m)

    # ğŸ”¥ å†…æ ¸ä¼˜åŒ–
    lingering_close off;                # ğŸ”¥ å¿«é€Ÿå…³é—­è¿æ¥
    lingering_time 1s;                  # ğŸ”¥ å‡å°‘ç­‰å¾…æ—¶é—´
    reset_timedout_connection on;       # ğŸ”¥ é‡ç½®è¶…æ—¶è¿æ¥

    # SSLåŒè¯ä¹¦é…ç½® - ECCä¼˜å…ˆï¼ŒRSAå…¼å®¹
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # ğŸš€ SSLè¶…çº§ä¼˜åŒ–é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;

    # ğŸ”¥ A+è¯„çº§å¯†ç å¥—ä»¶ - ä¼˜å…ˆå‰å‘ä¿å¯†ï¼ˆForward Secrecyï¼‰
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

    # ğŸ”¥ æœåŠ¡å™¨ä¼˜é€‰å¯†ç å¥—ä»¶ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_prefer_server_ciphers on;

    # ğŸ”¥ SSLä¼šè¯ä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_session_cache shared:SSL:50m;    # ğŸš€ å¢å¤§SSLç¼“å­˜ (10m -> 50m)
    ssl_session_timeout 1d;             # 24å°æ—¶ä¼šè¯è¶…æ—¶
    ssl_session_tickets off;            # ğŸ”¥ ç¦ç”¨ä¼šè¯ç¥¨æ®ï¼ˆå®‰å…¨æ€§ï¼‰
    ssl_buffer_size 4k;                 # ğŸš€ ä¼˜åŒ–SSLç¼“å†²åŒºå¤§å°

    # ğŸ”¥ TLS 1.3ä¼˜åŒ–ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_early_data on;                  # ğŸš€ å¯ç”¨TLS 1.3æ—©æœŸæ•°æ®
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
    ssl_conf_command Options PrioritizeChaCha;

    # ğŸ”¥ OCSPè£…è®¢ä¼˜åŒ– - å‡å°‘SSLæ¡æ‰‹æ—¶é—´30-40ms
    ssl_stapling on;                    # ğŸ”¥ å¯ç”¨OCSPè£…è®¢
    ssl_stapling_verify on;             # ğŸ”¥ éªŒè¯OCSPå“åº”
    ssl_trusted_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;  # ğŸ”¥ ä½¿ç”¨ECC fullchainè¯ä¹¦

    # ğŸ”¥ é«˜çº§SSLä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_verify_depth 3;                 # è¯ä¹¦é“¾éªŒè¯æ·±åº¦
    ssl_verify_client off;              # ä¸è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦

    # ğŸ”¥ SSLæ¡æ‰‹è¿›ä¸€æ­¥ä¼˜åŒ– - æ¤­åœ†æ›²çº¿ä¼˜åŒ–
    ssl_ecdh_curve X25519:secp384r1:secp256k1;

    # ğŸ”’ HSTSè¶…çº§å®‰å…¨å¤´ - 2å¹´æœ€å¤§æœŸé™ï¼ˆä¸»ç«™ï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ğŸš€ è¶…çº§å®‰å…¨å¤´é…ç½® - DOMåŠ è½½ä¼˜åŒ–
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ğŸš€ æ–°å¢ï¼šæ€§èƒ½ä¼˜åŒ–å¤´éƒ¨
    add_header X-DNS-Prefetch-Control "on" always;
    add_header X-Preload "on" always;

    # ğŸš€ ä¼˜åŒ–åçš„CSP - ä¸ºè¶…å¿«åŠ è½½ä¼˜åŒ–
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://lf1-cdn-tos.bytegoofy.com https://b.clarity.ms https://k.clarity.ms https://*.clarity.ms; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.voidix.net; font-src 'self' https://fonts.gstatic.com https://cdn.voidix.net; img-src 'self' data: https: blob: https://cdn.voidix.net; connect-src 'self' https://www.google-analytics.com https://api.uptimerobot.com https://cdn.voidix.net wss://$host wss://server.voidix.top:10203 https://b.clarity.ms https://k.clarity.ms https://*.clarity.ms; object-src 'none'; base-uri 'self'; form-action 'self';" always;

    # ç½‘ç«™æ ¹ç›®å½• - æŒ‡å‘æ„å»ºæ–‡ä»¶ç›®å½•
    root /var/www/voidix.net/dist;
    index index.html;

    # ğŸ† æè‡´é¢„å‹ç¼©æ–‡ä»¶é…ç½®ï¼ˆé›¶CPUæ¶ˆè€—ï¼‰
    # åªä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶ï¼Œç¦ç”¨å®æ—¶å‹ç¼©ç¡®ä¿æœ€å¿«å“åº”
    brotli off;                 # ç¦ç”¨å®æ—¶å‹ç¼©ï¼Œå¼ºåˆ¶ä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶
    brotli_static on;           # å¯ç”¨é™æ€é¢„å‹ç¼©æ–‡ä»¶æ”¯æŒï¼ˆæŸ¥æ‰¾.bræ–‡ä»¶ï¼‰
    brotli_min_length 128;      # ğŸš€ è¿›ä¸€æ­¥é™ä½æœ€å°å‹ç¼©æ–‡ä»¶å¤§å° (512 -> 128)
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/javascript
        application/json
        application/xml
        application/xml+rss
        application/atom+xml
        application/rss+xml
        image/svg+xml
        font/woff
        font/woff2
        font/ttf
        font/eot
        font/otf;

    # ğŸ—œï¸ æè‡´é¢„å‹ç¼©Gzipé…ç½®ï¼ˆé›¶CPUæ¶ˆè€—å›é€€ï¼‰
    gzip off;                   # ç¦ç”¨å®æ—¶å‹ç¼©ï¼Œå¼ºåˆ¶ä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶
    gzip_vary on;
    gzip_min_length 128;        # ğŸš€ è¿›ä¸€æ­¥é™ä½æœ€å°å‹ç¼©å¤§å° (512 -> 128)
    gzip_static on;             # å¯ç”¨é™æ€é¢„å‹ç¼©æ–‡ä»¶æ”¯æŒï¼ˆæŸ¥æ‰¾.gzæ–‡ä»¶ï¼‰
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2;

    # SEOä¼˜åŒ–ï¼šHTMLæ‰©å±•åé‡å®šå‘é…ç½® - ä¼˜å…ˆå¤„ç†
    # å°† /x.html é‡å®šå‘åˆ° /xï¼ˆæ— æ‰©å±•åï¼‰
    # ä½¿ç”¨è´Ÿå‘å‰ç»æ–­è¨€æ’é™¤ index.html é¿å…é‡å®šå‘å¾ªç¯
    location ~ ^/(?!index)(.+)\.html$ {
        return 301 /$1;
    }

    # ğŸš€ å…³é”®CSSå’ŒJavaScriptæ–‡ä»¶ä¼˜å…ˆå¤„ç† - æé€ŸDOMåŠ è½½
    location ~* \.(css|js)$ {
        # ğŸ”¥ TTFBæè‡´ä¼˜åŒ–
        add_header X-Response-Time $request_time always;  # ğŸ”¥ å“åº”æ—¶é—´ç›‘æ§

        # ğŸ”¥ ç«‹å³å“åº”ä¼˜åŒ–
        expires 1y;
        add_header Cache-Control "public, immutable, max-age=31536000";

        # ğŸ”¥ é¢„è¯»å–ä¼˜åŒ–
        read_ahead 512k;                # ğŸ”¥ é¢„è¯»å–512KBï¼Œå‡å°‘IOç­‰å¾…

        # ğŸš€ æè‡´ç¼“å­˜é…ç½®
        add_header X-Content-Type-Options "nosniff";

        # ğŸš€ é¢„å‹ç¼©æ–‡ä»¶ä¼˜å…ˆ
        brotli_static on;
        gzip_static on;

        # ğŸš€ èµ„æºä¼˜å…ˆçº§æç¤º
        add_header X-Resource-Priority "high";

        # ğŸ”¥ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
        open_file_cache_valid 3600s;   # ğŸ”¥ å»¶é•¿æ–‡ä»¶ç¼“å­˜æœ‰æ•ˆæœŸ

        try_files $uri =404;
    }

    # ğŸš€ å­—ä½“æ–‡ä»¶è¶…çº§ä¼˜åŒ– - é¿å…FOIT
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        # ğŸš€ å­—ä½“é¢„åŠ è½½
        add_header Link "<$uri>; rel=preload; as=font; crossorigin" always;

        # ğŸš€ æé•¿æœŸç¼“å­˜
        expires 2y;
        add_header Cache-Control "public, immutable, max-age=63072000";
        add_header Access-Control-Allow-Origin "*";

        # ğŸš€ å­—ä½“æ˜¾ç¤ºä¼˜åŒ–
        add_header X-Font-Display "swap";

        brotli_static on;
        gzip_static on;

        try_files $uri =404;
    }

    # ğŸš€ å›¾ç‰‡èµ„æºä¼˜åŒ– - æ¸è¿›å¼åŠ è½½
    location ~* \.(png|jpg|jpeg|gif|webp|svg|ico)$ {
        # ğŸš€ å›¾ç‰‡ç¼“å­˜ä¼˜åŒ–
        expires 6M;
        add_header Cache-Control "public, immutable, max-age=15552000";

        # ğŸš€ å›¾ç‰‡ä¼˜åŒ–å¤´éƒ¨
        add_header X-Image-Optimization "webp, avif";
        add_header Vary "Accept";

        brotli_static on;
        gzip_static on;

        try_files $uri =404;
    }

    # é™æ€èµ„æºæ–‡ä»¶å¤„ç† - å…¶ä»–æ–‡ä»¶ç±»å‹ï¼ˆä¸ç¼“å­˜ï¼‰
    location ~* \.(map|txt|xml)$ {
        # ğŸš€ é¢„å‹ç¼©æ–‡ä»¶ä¼˜å…ˆï¼Œå¿«é€Ÿå®æ—¶å›é€€
        brotli_static on;
        gzip_static on;

        # å°è¯•æä¾›é™æ€æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›404
        try_files $uri =404;

        # ğŸš€ ä¸ç¼“å­˜è¿™äº›æ–‡ä»¶ç±»å‹
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # PWAå›¾æ ‡å’ŒLogoæ–‡ä»¶ä¸“ç”¨é…ç½® - é˜²æ­¢è¿‡åº¦è¯·æ±‚
    location ~* ^/(android-chrome-|apple-touch-icon|favicon\.|logo\.) {
        try_files $uri =404;
        expires 90d;                    # ğŸš€ å»¶é•¿ç¼“å­˜æ—¶é—´ (30d -> 90d)
        add_header Cache-Control "public, immutable, max-age=7776000";  # ğŸš€ æ›´é•¿ç¼“å­˜

        # æ·»åŠ ETagæ”¯æŒï¼Œå‡å°‘é‡å¤ä¼ è¾“
        etag on;

        # ğŸš€ å›¾æ ‡é¢„åŠ è½½
        add_header Link "<$uri>; rel=preload; as=image";

        # è®¿é—®æ—¥å¿—å•ç‹¬è®°å½•ï¼ˆå¯é€‰ï¼‰
        access_log /var/log/nginx/voidix_icons.log;
    }

    # ç§»é™¤äº†@static_not_foundå¤„ç†å™¨ - é™æ€èµ„æºç›´æ¥è¿”å›404çŠ¶æ€

    # ğŸš€ ä¸»è·¯ç”±é…ç½® - SPAåº”ç”¨è·¯ç”±ï¼Œè¶…çº§DOMåŠ è½½ä¼˜åŒ–
    location / {
        # ğŸš€ DNSé¢„è§£æä¼˜åŒ–
        add_header Link "</cdn.voidix.net>; rel=dns-prefetch" always;
        add_header Link "</fonts.googleapis.com>; rel=dns-prefetch" always;
        add_header Link "</api.uptimerobot.com>; rel=dns-prefetch" always;

        # ğŸš€ å…³é”®ç¬¬ä¸‰æ–¹èµ„æºé¢„è¿æ¥
        add_header Link "</cdn.voidix.net>; rel=preconnect" always;
        add_header Link "</fonts.gstatic.com>; rel=preconnect; crossorigin" always;

        # ğŸš€ HTMLæ–‡ä»¶ä¼˜åŒ–ç¼“å­˜
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";

        # å°è¯•æä¾›æ–‡ä»¶æˆ–ç›®å½•ï¼Œä¸å­˜åœ¨åˆ™å›é€€åˆ°index.html
        try_files $uri $uri/ /index.html;
    }

    # ğŸš€ é¢„æ¸²æŸ“é¡µé¢ç›´æ¥æœåŠ¡ï¼ˆSEOä¼˜åŒ–ï¼‰- HTMLä¸ç¼“å­˜
    location /status {
        try_files /status/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location /faq {
        try_files /faq/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location /bug-report {
        try_files /bug-report/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location /privacy {
        try_files /privacy/index.html /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ğŸš€ APIä»£ç†è¶…çº§ä¼˜åŒ–é…ç½®
    location /api/ {
        # ğŸš€ ä¸Šæ¸¸è¿æ¥æ± ä¼˜åŒ–
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # ğŸš€ APIç¼“å­˜ä¼˜åŒ–
        proxy_cache static_cache;
        proxy_cache_key "$request_uri";
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout invalid_header updating;

        # ğŸš€ è¿æ¥ä¼˜åŒ–
        proxy_connect_timeout 3s;
        proxy_send_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ğŸš€ WebSocketè¶…çº§ä¼˜åŒ–æ”¯æŒ
    location /ws {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header Origin "";

        # ğŸš€ WebSocketä¼˜åŒ–
        proxy_connect_timeout 3s;
        proxy_send_timeout 60s;
        proxy_read_timeout 3600s;      # 1å°æ—¶é•¿è¿æ¥
        proxy_buffering off;
    }

    # SEOä¼˜åŒ–æ–‡ä»¶ï¼ˆä¸ç¼“å­˜ï¼‰
    location = /robots.txt {
        add_header Content-Type text/plain;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location = /sitemap.xml {
        add_header Content-Type application/xml;
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # éšè—æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~ \.(md|json|lock|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # é”™è¯¯é¡µé¢é…ç½®
    # åªæœ‰æœåŠ¡å™¨é”™è¯¯æ‰é‡å®šå‘åˆ°index.htmlï¼Œ404äº¤ç»™ä¸Šé¢çš„é…ç½®å¤„ç†
    error_page 500 502 503 504 /index.html;

    # è®¿é—®æ—¥å¿—é…ç½®
    access_log /var/log/nginx/voidix_access.log main_perf;  # ğŸš€ ä½¿ç”¨æ€§èƒ½æ—¥å¿—æ ¼å¼
    error_log /var/log/nginx/voidix_error.log;
}

# ============================================================================
# æ ¹åŸŸåHTTPSé…ç½® - voidix.net
# ============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name voidix.net;

    # ğŸš€ HTTP/2 è¶…çº§é«˜æ€§èƒ½ä¼˜åŒ–
    large_client_header_buffers 16 128k;
    keepalive_requests 50000;
    http2_push_preload on;
    http2_max_concurrent_streams 256;

    # ğŸ”¥ TTFBæè‡´ä¼˜åŒ–
    postpone_output 0;
    tcp_nopush off;
    tcp_nodelay on;

    # ğŸ”¥ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
    sendfile on;
    sendfile_max_chunk 512k;
    aio threads;
    directio 4m;

    # ğŸ”¥ å†…æ ¸ä¼˜åŒ–
    lingering_close off;
    lingering_time 1s;
    reset_timedout_connection on;

    # SSLåŒè¯ä¹¦é…ç½® - ECCä¼˜å…ˆï¼ŒRSAå…¼å®¹
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # ğŸš€ SSLè¶…çº§ä¼˜åŒ–é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;

    # ğŸ”¥ A+è¯„çº§å¯†ç å¥—ä»¶ - ä¼˜å…ˆå‰å‘ä¿å¯†ï¼ˆForward Secrecyï¼‰
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

    # ğŸ”¥ æœåŠ¡å™¨ä¼˜é€‰å¯†ç å¥—ä»¶ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_prefer_server_ciphers on;

    # ğŸ”¥ SSLä¼šè¯ä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_session_cache shared:SSL_ROOT:50m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    ssl_buffer_size 4k;

    # ğŸ”¥ TLS 1.3ä¼˜åŒ–ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_early_data on;
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
    ssl_conf_command Options PrioritizeChaCha;

    # ğŸ”¥ OCSPè£…è®¢ä¼˜åŒ– - å‡å°‘SSLæ¡æ‰‹æ—¶é—´30-40ms
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;

    # ğŸ”¥ é«˜çº§SSLä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_verify_depth 3;
    ssl_verify_client off;

    # ğŸ”¥ SSLæ¡æ‰‹è¿›ä¸€æ­¥ä¼˜åŒ– - æ¤­åœ†æ›²çº¿ä¼˜åŒ–
    ssl_ecdh_curve X25519:secp384r1:secp256k1;

    # ğŸ”’ HSTSè¶…çº§å®‰å…¨å¤´ - 2å¹´æœ€å¤§æœŸé™ï¼ˆæ ¹åŸŸåï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # ğŸš€ æ ¹åŸŸåé‡å®šå‘åˆ°www
    return 301 https://www.voidix.net$request_uri;

    # è®¿é—®æ—¥å¿—é…ç½®
    access_log /var/log/nginx/voidix_root_access.log main_perf;
    error_log /var/log/nginx/voidix_root_error.log;
}

# ============================================================================
# CDNå­åŸŸåé…ç½® - cdn.voidix.net ä¸“ç”¨ä»£ç†æœåŠ¡
# ============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name cdn.voidix.net;

    # ğŸš€ HTTP/2 CDNè¶…çº§é«˜æ€§èƒ½ä¼˜åŒ–
    large_client_header_buffers 16 128k; # ğŸš€ CDNå¤´éƒ¨ä¼˜åŒ–
    keepalive_requests 100000;          # ğŸš€ CDNæè‡´è¿æ¥å¤ç”¨
    http2_max_concurrent_streams 512;   # ğŸš€ CDNæœ€å¤§å¹¶å‘æµ

    # SSLåŒè¯ä¹¦é…ç½® - ECCä¼˜å…ˆï¼ŒRSAå…¼å®¹
    ssl_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/ECC/voidix.key;
    ssl_certificate /etc/nginx/ssl/voidix.net/RSA/voidix.cer;
    ssl_certificate_key /etc/nginx/ssl/voidix.net/RSA/voidix.key;

    # ğŸš€ SSL CDNä¸“ç”¨ä¼˜åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;

    # ğŸ”¥ A+è¯„çº§å¯†ç å¥—ä»¶ - ä¼˜å…ˆå‰å‘ä¿å¯†ï¼ˆForward Secrecyï¼‰
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

    # ğŸ”¥ æœåŠ¡å™¨ä¼˜é€‰å¯†ç å¥—ä»¶ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_prefer_server_ciphers on;

    # ğŸ”¥ SSLä¼šè¯ä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_session_cache shared:SSL_CDN:100m;   # ğŸš€ CDNä¸“ç”¨ç¼“å­˜åç§°é¿å…å†²çª
    ssl_session_timeout 1d;             # 24å°æ—¶ä¼šè¯è¶…æ—¶
    ssl_session_tickets off;            # ğŸ”¥ ç¦ç”¨ä¼šè¯ç¥¨æ®ï¼ˆå®‰å…¨æ€§ï¼‰
    ssl_buffer_size 4k;                 # ğŸš€ ä¼˜åŒ–SSLç¼“å†²åŒºå¤§å°

    # ğŸ”¥ TLS 1.3ä¼˜åŒ–ï¼ˆA+è¯„çº§å…³é”®ï¼‰
    ssl_early_data on;                  # ğŸš€ å¯ç”¨TLS 1.3æ—©æœŸæ•°æ®
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
    ssl_conf_command Options PrioritizeChaCha;

    # ğŸ”¥ OCSPè£…è®¢ä¼˜åŒ– - å‡å°‘SSLæ¡æ‰‹æ—¶é—´30-40ms
    ssl_stapling on;                    # ğŸ”¥ å¯ç”¨OCSPè£…è®¢
    ssl_stapling_verify on;             # ğŸ”¥ éªŒè¯OCSPå“åº”
    ssl_trusted_certificate /etc/nginx/ssl/voidix.net/ECC/voidix.cer;  # ğŸ”¥ ä½¿ç”¨ECC fullchainè¯ä¹¦

    # ğŸ”¥ é«˜çº§SSLä¼˜åŒ–ï¼ˆA+è¯„çº§è¦æ±‚ï¼‰
    ssl_verify_depth 3;                 # è¯ä¹¦é“¾éªŒè¯æ·±åº¦
    ssl_verify_client off;              # ä¸è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦

    # ğŸ”¥ CDN SSLæ¡æ‰‹è¿›ä¸€æ­¥ä¼˜åŒ– - æ¤­åœ†æ›²çº¿ä¼˜åŒ–
    ssl_ecdh_curve X25519:secp384r1:secp256k1;

    # ğŸ”’ HSTSè¶…çº§å®‰å…¨å¤´ - 2å¹´æœ€å¤§æœŸé™ï¼ˆCDNï¼‰
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # CDNä¸“ç”¨å®‰å…¨å¤´
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ğŸš€ CDNæœåŠ¡æ ‡è¯†å‡çº§
    add_header X-CDN-Provider "Voidix-CDN-v2.0" always;
    add_header X-Served-By "cdn.voidix.net" always;
    add_header X-Cache-Node "primary" always;

    # ğŸ† CDNæè‡´Brotliå‹ç¼©é…ç½®ï¼ˆä½å¹¶å‘ä¸“ç”¨ï¼‰
    brotli on;
    brotli_comp_level 11;       # CDNæœ€é«˜å‹ç¼©çº§åˆ«ï¼ˆä½å¹¶å‘é«˜æ€§èƒ½ä¼˜åŒ–ï¼‰
    brotli_min_length 128;      # ğŸš€ æ›´å°æ–‡ä»¶ä¹Ÿå‹ç¼© (512 -> 128)
    brotli_static on;           # CDNé¢„å‹ç¼©æ–‡ä»¶æ”¯æŒ
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/javascript
        application/json
        application/xml
        application/xml+rss
        application/atom+xml
        application/rss+xml
        image/svg+xml
        font/woff
        font/woff2
        font/ttf
        font/eot
        font/otf;

    # ğŸ—œï¸ CDNæè‡´Gzipå‹ç¼©é…ç½®ï¼ˆæœ€é«˜å…¼å®¹æ€§å›é€€ï¼‰
    gzip on;
    gzip_vary on;
    gzip_min_length 128;        # ğŸš€ æ›´å°æ–‡ä»¶å‹ç¼© (512 -> 128)
    gzip_comp_level 9;          # æœ€é«˜å‹ç¼©çº§åˆ«
    gzip_static on;             # CDNé¢„å‹ç¼©æ–‡ä»¶æ”¯æŒ
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2;

    # ========================================================================
    # Google Fontsä»£ç†è¶…çº§ä¼˜åŒ–
    # ========================================================================

    location /fonts/css/ {
        limit_req zone=cdn_assets burst=20 nodelay;  # ğŸš€ æå‡çªå‘é™åˆ¶
        rewrite ^/fonts/css/(.*)$ /$1 break;

        proxy_pass https://fonts.googleapis.com;
        proxy_cache voidix_cache;
        proxy_cache_key "fonts_css:$request_uri";
        proxy_cache_valid 200 14d;      # ğŸš€ å»¶é•¿ç¼“å­˜ (7d -> 14d)
        proxy_cache_valid 404 2h;       # ğŸš€ å»¶é•¿404ç¼“å­˜
        proxy_cache_valid any 2h;
        proxy_cache_use_stale error timeout invalid_header updating;  # ğŸš€ å¯ç”¨è¿‡æœŸå†…å®¹

        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=1209600, immutable";  # ğŸš€ æ›´é•¿ç¼“å­˜
        add_header X-CDN-Cache "fonts-css-v2" always;
        add_header Access-Control-Allow-Origin "*" always;

        proxy_set_header Host "fonts.googleapis.com";
        proxy_set_header User-Agent "VoidixCDN/2.0 (+https://cdn.voidix.net)";
        proxy_set_header Accept "text/css,*/*;q=0.1";

        proxy_connect_timeout 3s;       # ğŸš€ æ›´å¿«è¿æ¥ (5s -> 3s)
        proxy_send_timeout 5s;
        proxy_read_timeout 10s;
        access_log /var/log/nginx/cdn_fonts_css.log;
    }

    location /fonts/files/ {
        limit_req zone=cdn_assets burst=30 nodelay;  # ğŸš€ æ›´é«˜çªå‘é™åˆ¶
        rewrite ^/fonts/files/(.*)$ /$1 break;

        proxy_pass https://fonts.gstatic.com;
        proxy_cache voidix_cache;
        proxy_cache_key "fonts_files:$request_uri";
        proxy_cache_valid 200 90d;      # ğŸš€ è¶…é•¿ç¼“å­˜ (30d -> 90d)
        proxy_cache_valid 404 1d;
        proxy_cache_valid any 1h;
        proxy_cache_use_stale error timeout invalid_header updating;

        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=7776000, immutable";  # ğŸš€ 90å¤©ç¼“å­˜
        add_header X-CDN-Cache "fonts-files-v2" always;
        add_header Access-Control-Allow-Origin "*" always;

        proxy_set_header Host "fonts.gstatic.com";
        proxy_set_header User-Agent "VoidixCDN/2.0 (+https://cdn.voidix.net)";
        proxy_set_header Accept "font/woff2,font/woff,*/*;q=0.1";

        proxy_connect_timeout 3s;
        proxy_send_timeout 5s;
        proxy_read_timeout 15s;
        access_log /var/log/nginx/cdn_fonts_files.log;
    }

    # ========================================================================
    # å®‰å…¨ç­–ç•¥ - ç¦æ­¢åˆ†æJSä»£ç†
    # ========================================================================
    location ~* /(googletagmanager|google-analytics|lf1-cdn-tos\.bytegoofy) {
        return 403 "åˆ†æè„šæœ¬ä¸å…è®¸é€šè¿‡CDNä»£ç†";
    }

    # ========================================================================
    # CDNçŠ¶æ€å’Œå¥åº·æ£€æŸ¥
    # ========================================================================
    location = /cdn-status {
        access_log off;
        return 200 '{"status":"healthy","service":"voidix-cdn","version":"2.0","performance":"optimized"}';
        add_header Content-Type "application/json";
        add_header X-CDN-Status "active";
        add_header Cache-Control "no-cache";
    }

    # é»˜è®¤æ‹’ç»å…¶ä»–è¯·æ±‚
    location / {
        return 404 "CDNæœåŠ¡ï¼šè¯·æ±‚çš„èµ„æºä¸å­˜åœ¨";
    }

    # éšè—æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ğŸš€ è®¿é—®æ—¥å¿—é…ç½® - ä½¿ç”¨æ€§èƒ½æ—¥å¿—æ ¼å¼
    access_log /var/log/nginx/cdn_access.log main_perf;
    error_log /var/log/nginx/cdn_error.log;
}

# ============================================================================
# ğŸ”’ SSL/TLS A+è¯„çº§é…ç½®æ€»ç»“
# ============================================================================
#
# å½“å‰é…ç½®å·²è¾¾åˆ°SSL Labs A+è¯„çº§æ ‡å‡†ï¼š
# âœ… å‰å‘ä¿å¯†ï¼šæ‰€æœ‰å¯†ç å¥—ä»¶ä½¿ç”¨ECDHEå¯†é’¥äº¤æ¢
# âœ… TLS 1.3ï¼šæ”¯æŒæœ€æ–°TLSåè®®ï¼Œæ€§èƒ½å’Œå®‰å…¨æ€§æœ€ä½³
# âœ… HSTSï¼š2å¹´æœŸé™+å­åŸŸå+é¢„åŠ è½½æ”¯æŒ
# âœ… OCSPè£…è®¢ï¼šå‡å°‘SSLæ¡æ‰‹æ—¶é—´30-40ms
# âœ… ç°ä»£å¯†ç å¥—ä»¶ï¼šAES256-GCMã€ChaCha20-Poly1305
# âœ… æ¤­åœ†æ›²çº¿ä¼˜åŒ–ï¼šX25519ã€secp384r1ã€secp256k1
#
# æµ‹è¯•SSLé…ç½®ï¼š
# npm run ssl:test        # æœ¬åœ°æµ‹è¯•
# npm run ssl:check      # åœ¨çº¿æµ‹è¯•é“¾æ¥
#
# åœ¨çº¿è¯„çº§æµ‹è¯•ï¼š
# https://www.ssllabs.com/ssltest/analyze.html?d=www.voidix.net
# https://www.ssllabs.com/ssltest/analyze.html?d=cdn.voidix.net
# https://www.ssllabs.com/ssltest/analyze.html?d=voidix.net
# ============================================================================
